<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Interaktivní kartézská mřížka</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: Arial, sans-serif;
            touch-action: none; /* Disable browser's default touch actions */
        }
        #canvas-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            background-color: #f0f0f0;
            overflow: hidden;
            transition: transform 0.3s ease-in-out;
        }
        #canvas-container.panel-open {
            transform: translateY(calc(-1 * var(--panel-height, 50vh)));
        }
        canvas {
            position: absolute;
            top: 0;
            left: 0;
            touch-action: none; /* Zakáže základní dotykové chování, abychom mohli implementovat vlastní */
        }
        .controls {
            position: absolute;
            top: 60px; /* Posunuto výše, aby nezasahovalo do přehrávače na mobilu */
            right: 20px;
            background-color: rgba(255, 255, 255, 0.5); /* Zvýšená průhlednost na 50% */
            padding: 5px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
            z-index: 1002;
            transition: transform 0.3s ease-in-out;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .controls.hidden {
            display: none;
        }
        
        .controls.panel-open {
            transform: translateY(calc(-1 * var(--panel-height, 50vh) + 240px));
        }
        .controls button {
            margin: 2px;
            width: 40px;
            height: 30px;
            line-height: 1;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }
        .coordinates {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background-color: rgba(255, 255, 255, 0.8);
            padding: 8px 12px;
            border-radius: 5px;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);
            font-size: 14px; /* Větší text pro lepší čitelnost na mobilních zařízeních */
            z-index: 1000;
        }
        @media (max-width: 768px) {
            .controls {
                top: 100px; /* Ještě výše na mobilních zařízeních */
                right: 15px;
                padding: 8px;
            }
            .controls button {
                padding: 12px 16px; /* Ještě větší tlačítka na malých obrazovkách */
                margin: 4px;
                width: 50px; /* Větší tlačítka na dotykovém zařízení */
                height: 50px;
                font-size: 24px;
            }
            .coordinates {
                font-size: 16px; /* Větší text na mobilních zařízeních */
            }
        }

        /* Styly pro vysouvací panel */
        .sliding-panel {
            position: fixed;
            bottom: -50vh; /* Změněno z pevné hodnoty na relativní */
            left: 0;
            width: 100%; /* Panel přes celou šířku */
            height: 50vh; /* Výchozí výška je 50% výšky obrazovky */
            background-color: rgba(255, 255, 255, 0.5); /* Zvýšená průhlednost na 50% */
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s ease-in-out;
            z-index: 1000;
        }

        .sliding-panel.open {
            transform: translateY(-100%);
        }

        .panel-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            z-index: 1001;
            transition: transform 0.3s ease-in-out;
        }

        .panel-toggle.panel-open {
            transform: translateY(calc(-1 * var(--panel-height, 50vh)));
        }

        .panel-content {
            padding: 30px 20px 20px 20px; /* Zvětšit horní padding pro táhlo */
            height: calc(100% - 50px);
            overflow-y: auto;
        }

        /* Přidat táhlo pro resize */
        .panel-handle {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 20px;
            background: #f0f0f0;
            cursor: row-resize;
            border-radius: 8px 8px 0 0;
            border-bottom: 1px solid #ddd;
        }

        /* Vizuální indikátor pro táhlo */
        .panel-handle::before {
            content: '';
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 50px;
            height: 4px;
            background: #ccc;
            border-radius: 4px;
        }

        /* Přizpůsobení pro mobilní zařízení */
        @media (max-width: 768px) {
            .sliding-panel {
                width: 100%;
                right: 0;
            }
        }

        /* Přidat nový styl pro playback controls */
        .playback-controls {
            position: fixed;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(255, 255, 255, 0.5); /* Zvýšená průhlednost na 50% */
            padding: 8px;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(5px); /* Rozmazané pozadí */
            -webkit-backdrop-filter: blur(5px); /* Pro Safari */
            z-index: 1002;
            display: flex;
            gap: 8px;
            transition: transform 0.3s ease-in-out;
        }

        .playback-controls.panel-open {
            transform: translate(-50%, calc(-1 * var(--panel-height, 50vh)));
        }

        .playback-controls button {
            width: 36px;
            height: 36px;
            border-radius: 5px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            background-color: rgba(255, 255, 255, 0.8);
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
        }

        .playback-controls button:hover {
            background-color: #f0f0f0;
        }

        .playback-controls .speed-controls {
            display: flex;
            gap: 4px;
            margin-left: 12px;
            padding-left: 12px;
            border-left: 1px solid rgba(0, 0, 0, 0.1);
        }

        .playback-speed {
            font-size: 14px;
            line-height: 36px;
            margin: 0 8px;
            white-space: nowrap;
            color: rgba(0, 0, 0, 0.8);
        }

        /* Optimalizace pro mobilní zařízení */
        @media (max-width: 768px) {
            .playback-controls {
                bottom: 60px;
                padding: 6px;
                gap: 4px;
                width: 90%; /* Omezení šířky na mobilech */
                max-width: 400px; /* Maximální šířka */
            }

            .playback-controls button {
                width: 32px;
                height: 32px;
                font-size: 14px;
            }

            .playback-controls .speed-controls {
                margin-left: 8px;
                padding-left: 8px;
            }

            .playback-speed {
                font-size: 12px;
                line-height: 32px;
                margin: 0 4px;
            }
        }

        /* Orientace na šířku pro mobilní zařízení */
        @media (max-height: 500px) {
            .playback-controls {
                bottom: auto;
                top: 10px;
            }
        }

        /* Styl pro křížek při podržení */
        .cross-marker {
            position: absolute;
            pointer-events: none; /* Aby křížek nebránil interakci s canvasem */
            z-index: 1005;
            display: none;
            transform: translate(-50%, -50%); /* Vycentrování křížku */
        }
        
        .cross-marker::before,
        .cross-marker::after {
            content: '';
            position: absolute;
            background-color: rgba(255, 0, 0, 0.8);
        }
        
        .cross-marker::before {
            width: 20px;
            height: 2px;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        
        .cross-marker::after {
            width: 2px;
            height: 20px;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        
        /* Toggle button for controls */
        .controls-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 5px 10px;
            background-color: rgba(255, 255, 255, 0.5);
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
            z-index: 1003;
            cursor: pointer;
            font-size: 14px;
            border: 1px solid #ccc;
            width: 40px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .controls-toggle:hover {
            background-color: rgba(240, 240, 240, 0.9);
        }
    </style>
</head>
<body>
    <div id="canvas-container">
        <canvas id="grid-canvas"></canvas>
        <div class="controls">
            <button id="zoom-in">+</button>
            <button id="zoom-out">−</button>
            <button id="reset" title="Reset zobrazení">↺</button>
        </div>
        <div class="coordinates" id="coord-display">X: 0, Z: 0</div>
        <div class="cross-marker" id="cross-marker"></div>
        <div id="debug-display" style="position: fixed; top: 10px; left: 10px; background: rgba(255,255,255,0.8); padding: 5px; font-size: 12px; display: none;"></div>
    </div>

    <div class="playback-controls" id="playback-controls">
        <button id="step-backward" title="Krok vzad">⏮</button>
        <button id="play-pause" title="Přehrát/Pozastavit">▶</button>
        <button id="step-forward" title="Krok vpřed">⏭</button>
        <button id="stop" title="Stop">⏹</button>
        <div class="speed-controls">
            <button id="speed-down" title="Snížit rychlost">−</button>
            <span class="playback-speed" id="speed-display">1×</span>
            <button id="speed-up" title="Zvýšit rychlost">+</button>
            <button id="speed-reset" title="Resetovat rychlost">↺</button>
        </div>
        <button id="controls-toggle" title="Zobrazit/skrýt ovládání">👁️</button>
        <button id="panel-toggle" title="Otevřít/zavřít panel">☰</button>
    </div>

    <div class="sliding-panel" id="sliding-panel">
        <div class="panel-handle" id="panel-handle"></div>
        <div class="panel-content">
            <h2>Informační Panel</h2>
            <p>Zde můžete přidat libovolný obsah...</p>
        </div>
    </div>

    <script>
        // Základní nastavení
        const canvas = document.getElementById('grid-canvas');
        const ctx = canvas.getContext('2d');
        const coordDisplay = document.getElementById('coord-display');
        const crossMarker = document.getElementById('cross-marker');
        const debugDisplay = document.getElementById('debug-display');

        // Výchozí nastavení pro mřížku
        let scale = 40; // Počet pixelů na jednotku
        let offsetX = 0; // Posun ve směru X
        let offsetY = 0; // Posun ve směru Y
        let isDragging = false;
        let lastX, lastY;
        let minGridSpacing = 30; // Minimální mezera mezi čarami mřížky v pixelech
        
        // Proměnné pro sledování stavu podržení
        let isHolding = false;
        let holdTimer = null;
        let holdDuration = 300; // Doba v ms, po kterou musí být tlačítko/dotek podržen
        
        // Proměnné pro pinch-to-zoom
        let initialPinchDistance = 0;
        let initialScale = 0;
        let lastPinchCenter = { x: 0, y: 0 };

        // Nastavení velikosti canvasu podle okna
        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            drawGrid();
        }

        // Inicializace po načtení stránky
        window.addEventListener('load', () => {
            resizeCanvas();

            // Nastavení počáteční pozice a měřítka pro zobrazení rozsahu 0-700 na vodorovné ose
            const targetRightX = 700;
            scale = canvas.width / targetRightX; // Měřítko, aby se zobrazil rozsah 0-700

            // Umístit počátek souřadnic do levého dolního rohu s offsetem
            offsetX = 25;  // Reduced by 50% (from 50px to 25px) from left edge
            offsetY = canvas.height - 168;  // Increased by 50% more (from 112px to 168px) from bottom edge

            drawGrid();
        });

        // Reagovat na změnu velikosti okna
        window.addEventListener('resize', resizeCanvas);

        // Funkce pro vykreslení mřížky
        function drawGrid() {
            // Vyčistit canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Určit, zda je viditelný středový kříž
            const isOriginXVisible = offsetX > 0 && offsetX < canvas.width;
            const isOriginYVisible = offsetY > 0 && offsetY < canvas.height;
            const isOriginVisible = isOriginXVisible && isOriginYVisible;

            // Vypočítat viditelnou oblast v souřadnicích mřížky
            const viewportLeft = -offsetX / scale;
            const viewportRight = (canvas.width - offsetX) / scale;
            const viewportTop = -offsetY / scale;
            const viewportBottom = (canvas.height - offsetY) / scale;

            // Určit vhodný interval mřížky na základě přiblížení
            const gridInterval = determineGridInterval(scale);

            // Vypočítat počáteční a koncové pozice čar
            const startX = Math.floor(viewportLeft / gridInterval) * gridInterval;
            const endX = Math.ceil(viewportRight / gridInterval) * gridInterval;
            const startY = Math.floor(viewportTop / gridInterval) * gridInterval;
            const endY = Math.ceil(viewportBottom / gridInterval) * gridInterval;

            // Vykreslit osy (silnější středový kříž)
            if (isOriginXVisible || isOriginYVisible) {
                // Tloušťka středového kříže je větší
                ctx.lineWidth = 2;
                ctx.strokeStyle = '#000000';
                ctx.beginPath();

                // Osa X
                if (isOriginYVisible) {
                    ctx.moveTo(0, offsetY);
                    ctx.lineTo(canvas.width, offsetY);
                }

                // Osa Y
                if (isOriginXVisible) {
                    ctx.moveTo(offsetX, 0);
                    ctx.lineTo(offsetX, canvas.height);
                }

                ctx.stroke();
            }

            // Vykreslit mřížku (běžné čáry)
            ctx.lineWidth = 1;
            ctx.strokeStyle = '#aaaaaa';
            ctx.beginPath();

            // Vertikální čáry
            for (let x = startX; x <= endX; x += gridInterval) {
                if (x === 0) continue; // Přeskočit osu Y, ta už je vykreslena výše
                const pixelX = offsetX + x * scale;
                ctx.moveTo(pixelX, 0);
                ctx.lineTo(pixelX, canvas.height);
            }

            // Horizontální čáry
            for (let y = startY; y <= endY; y += gridInterval) {
                if (y === 0) continue; // Přeskočit osu X, ta už je vykreslena výše
                const pixelY = offsetY + y * scale;
                ctx.moveTo(0, pixelY);
                ctx.lineTo(canvas.width, pixelY);
            }

            ctx.stroke();

            // Nastavení písma pro běžné hodnoty
            ctx.font = '12px Arial';
            ctx.fillStyle = '#333333';

            // Najít pozici druhé mřížky od každého okraje (místo třetí)
            const secondGridLeft = startX + 2 * gridInterval;
            const secondGridRight = endX - 2 * gridInterval;
            const secondGridTop = startY + 2 * gridInterval;
            const secondGridBottom = endY - 2 * gridInterval;

            // Pozice druhé mřížky v pixelech
            const secondPixelLeft = offsetX + secondGridLeft * scale;
            const secondPixelRight = offsetX + secondGridRight * scale;
            const secondPixelTop = offsetY + secondGridTop * scale;
            const secondPixelBottom = offsetY + secondGridBottom * scale;

            // Vykreslit hodnoty na mřížce
            // Vertikální čáry - hodnoty X
            for (let x = startX; x <= endX; x += gridInterval) {
                if (x === 0) continue; // Hodnotu pro 0 vykreslíme zvlášť
                const pixelX = offsetX + x * scale;
                const formattedX = parseFloat(x.toFixed(3)).toString();

                // Rozhodnutí, kde vykreslit hodnotu X
                if (isOriginYVisible) {
                    // Pokud je viditelná osa X, vykresli hodnotu na ose
                    ctx.fillText(formattedX, pixelX + 5, offsetY + 15);
                } else if (offsetY > canvas.height / 2) {
                    // Střed je pod dolní polovinou - vykresli blíže ke středu, tedy nahoře
                    ctx.fillText(formattedX, pixelX + 5, canvas.height - secondPixelTop + 15);
                } else {
                    // Střed je nad horní polovinou - vykresli blíže ke středu, tedy dole
                    ctx.fillText(formattedX, pixelX + 5, secondPixelBottom - 15);
                }
            }

            // Horizontální čáry - hodnoty Z
            for (let y = startY; y <= endY; y += gridInterval) {
                if (y === 0) continue; // Hodnotu pro 0 vykreslíme zvlášť
                const pixelY = offsetY + y * scale;
                const formattedY = parseFloat((-y).toFixed(3)).toString();

                // Rozhodnutí, kde vykreslit hodnotu Z
                if (isOriginXVisible) {
                    // Pokud je viditelná osa Y, vykresli hodnotu na ose
                    ctx.fillText(formattedY, offsetX + 5, pixelY + 15);
                } else if (offsetX > canvas.width / 2) {
                    // Střed je vpravo od plátna - vykresli blíže ke středu, tedy vpravo
                    // Použijeme pevný offset od pravého okraje pro konzistentnější zobrazení
                    ctx.fillText(formattedY, canvas.width - 50, pixelY + 15);
                } else {
                    // Střed je vlevo od plátna - vykresli blíže ke středu, tedy vlevo
                    // Použijeme pevný offset od levého okraje pro konzistentnější zobrazení
                    ctx.fillText(formattedY, 50, pixelY + 15);
                }
            }

            // Vykreslit počátek souřadnic s většími popisky
            if (isOriginVisible) {
                // Červený bod v počátku
                ctx.fillStyle = '#ff0000';
                ctx.beginPath();
                ctx.arc(offsetX, offsetY, 4, 0, 2 * Math.PI); // Větší bod
                ctx.fill();

                // Větší písmo pro hodnotu 0
                ctx.font = '14px Arial';
                ctx.fillStyle = '#000000'; // Tmavší barva pro lepší viditelnost
                ctx.fillText('0', offsetX + 6, offsetY + 16);
            }

            // Zobrazit referenční hodnoty na okrajích, pokud není vidět středový kříž
            if (!isOriginVisible) {
                ctx.font = '12px Arial';
                ctx.fillStyle = '#333333';

                // Referenční hodnoty pro viditelnou oblast
                const leftEdgeValue = parseFloat(viewportLeft.toFixed(3)).toString();
                const rightEdgeValue = parseFloat(viewportRight.toFixed(3)).toString();
                const topEdgeValue = parseFloat((-viewportTop).toFixed(3)).toString();
                const bottomEdgeValue = parseFloat((-viewportBottom).toFixed(3)).toString();

                // Zobrazit hodnoty na okrajích
                ctx.fillText(`X: ${leftEdgeValue}`, 10, canvas.height - 10);
                ctx.fillText(`X: ${rightEdgeValue}`, canvas.width - 80, canvas.height - 10);
                ctx.fillText(`Z: ${topEdgeValue}`, canvas.width - 80, 20);
                ctx.fillText(`Z: ${bottomEdgeValue}`, canvas.width - 80, canvas.height - 30);
            }
        }

        // Funkce pro určení vhodného intervalu mřížky
        function determineGridInterval(scale) {
            // Základ pro intervaly (mocniny 10)
            const base = 10;

            // Základní interval je 1
            let interval = 1;

            // Pokud jsme příliš přiblíženi, zmenšujeme interval
            while (interval * scale > minGridSpacing * 2) {
                interval /= base;
            }

            // Pokud jsme příliš oddáleni, zvětšujeme interval
            while (interval * scale < minGridSpacing) {
                interval *= base;
            }

            // Pro lepší vzhled můžeme přidat mezihodnoty (2, 5)
            const refinedIntervals = [1, 2, 5, 10];
            let magnitude = Math.pow(10, Math.floor(Math.log10(interval)));

            for (let i = 0; i < refinedIntervals.length; i++) {
                let refined = refinedIntervals[i] * magnitude;
                if (refined * scale >= minGridSpacing) {
                    return refined;
                }
            }

            return interval;
        }

        // Ovládání pro zoom a posun
        document.getElementById('zoom-in').addEventListener('click', () => {
            scale *= 1.2;
            drawGrid();
        });

        document.getElementById('zoom-out').addEventListener('click', () => {
            scale /= 1.2;
            drawGrid();
        });

        document.getElementById('reset').addEventListener('click', () => {
            // Nastavení měřítka pro zobrazení rozsahu 0-700 na vodorovné ose
            const targetRightX = 700;
            scale = canvas.width / targetRightX;

            // Resetovat do levého dolního rohu (místo do středu)
            offsetX = 25;  // Reduced by 50% (from 50px to 25px) from left edge
            offsetY = canvas.height - 168;  // Increased by 50% more (from 75px to 168px) from bottom edge
            drawGrid();
        });

        // Událost pro kolečko myši - zoom
        canvas.addEventListener('wheel', (e) => {
            e.preventDefault();

            // Získat souřadnice myši před zoomem
            const mouseX = e.clientX;
            const mouseY = e.clientY;

            // Vypočítat souřadnice v mřížce
            const gridX = (mouseX - offsetX) / scale;
            const gridY = (mouseY - offsetY) / scale;

            // Upravit měřítko podle směru kolečka
            if (e.deltaY < 0) {
                scale *= 1.1; // Přiblížit
            } else {
                scale /= 1.1; // Oddálit
            }

            // Upravit posun, aby bod pod kurzorem zůstal na stejném místě
            offsetX = mouseX - gridX * scale;
            offsetY = mouseY - gridY * scale;

            drawGrid();
        });

        // Události pro tažení myší
        canvas.addEventListener('mousedown', (e) => {
            isDragging = true;
            lastX = e.clientX;
            lastY = e.clientY;
            canvas.style.cursor = 'grabbing';
            
            // Začít odpočet pro podržení
            startHoldTimer(e.clientX, e.clientY);
        });

        canvas.addEventListener('mousemove', (e) => {
            // Aktualizovat zobrazení souřadnic a opravit nepřesnosti plovoucí desetinné čárky
            const rawX = (e.clientX - offsetX) / scale;
            const rawY = -(e.clientY - offsetY) / scale;
            // Zaokrouhlit na 3 desetinná místa a pak zobrazit
            const gridX = parseFloat(rawX.toFixed(3)).toString();
            const gridY = parseFloat(rawY.toFixed(3)).toString();
            
            // Zobrazit souřadnice pouze pokud není aktivní křížek
            if (!isHolding) {
                coordDisplay.textContent = `X: ${gridX}, Z: ${gridY}`;
            }

            if (isDragging) {
                // Pokud se uživatel pohybuje, zrušit odpočet pro podržení
                clearHoldTimer();
                
                // Pokud je zobrazen křížek a uživatel se pohybuje, aktualizovat jeho pozici
                if (isHolding) {
                    updateCrossMarkerPosition(e.clientX, e.clientY);
                } else {
                    // Standardní posun plátna
                    offsetX += e.clientX - lastX;
                    offsetY += e.clientY - lastY;
                    lastX = e.clientX;
                    lastY = e.clientY;
                    drawGrid();
                }
            }
        });

        canvas.addEventListener('mouseup', () => {
            isDragging = false;
            canvas.style.cursor = 'default';
            clearHoldTimer();
            hideCrossMarker();
        });

        canvas.addEventListener('mouseleave', () => {
            isDragging = false;
            canvas.style.cursor = 'default';
            clearHoldTimer();
            hideCrossMarker();
        });
        
        // Události pro dotykové ovládání - kompletně přepracované
        canvas.addEventListener('touchstart', (e) => {
            e.preventDefault(); // Zabránit výchozímu chování prohlížeče
            
            // Detekce pinch gesta (dva prsty)
            if (e.touches.length === 2) {
                // Vždy skrýt křížek při použití dvou prstů
                isHolding = false;
                crossMarker.style.display = 'none';
                clearHoldTimer();
                
                // Uložit počáteční vzdálenost mezi prsty
                initialPinchDistance = getPinchDistance(e.touches);
                initialScale = scale;
                
                // Uložit střed pinch gesta
                lastPinchCenter = getPinchCenter(e.touches);
                return;
            }
            
            // Standardní chování pro jeden prst
            isDragging = true;
            lastX = e.touches[0].clientX;
            lastY = e.touches[0].clientY;
            
            // Začít odpočet pro podržení
            startHoldTimer(e.touches[0].clientX, e.touches[0].clientY);
        });

        canvas.addEventListener('touchmove', (e) => {
            e.preventDefault(); // Zabránit výchozímu chování prohlížeče
            
            // Pinch-to-zoom (dva prsty)
            if (e.touches.length === 2) {
                // Vždy skrýt křížek při použití dvou prstů
                isHolding = false;
                crossMarker.style.display = 'none';
                clearHoldTimer();
                
                // Vypočítat aktuální vzdálenost mezi prsty
                const currentDistance = getPinchDistance(e.touches);
                
                // Získat střed pinch gesta
                const currentCenter = getPinchCenter(e.touches);
                
                // Změnit měřítko podle změny vzdálenosti
                if (initialPinchDistance > 0) {
                    // Vypočítat poměr změny vzdálenosti
                    const pinchRatio = currentDistance / initialPinchDistance;
                    
                    // Vypočítat nové měřítko
                    const newScale = Math.max(5, Math.min(initialScale * pinchRatio, 200));
                    
                    // Upravit offset tak, aby se zachoval střed zoomu
                    if (newScale !== scale) {
                        // Přizpůsobit offset, aby se zachoval střed pinch gesta
                        const zoomFactor = newScale / scale;
                        const centerX = currentCenter.x;
                        const centerY = currentCenter.y;
                        
                        offsetX = centerX - (centerX - offsetX) * zoomFactor;
                        offsetY = centerY - (centerY - offsetY) * zoomFactor;
                        
                        // Aktualizovat měřítko
                        scale = newScale;
                        
                        // Překreslit mřížku
                        drawGrid();
                    }
                }
                
                // Aktualizovat poslední střed
                lastPinchCenter = currentCenter;
                return;
            }
            
            // Standardní chování pro jeden prst
            if (isDragging) {
                const deltaX = e.touches[0].clientX - lastX;
                const deltaY = e.touches[0].clientY - lastY;
                
                // Pokud se uživatel pohybuje, zrušit odpočet pro podržení
                if (Math.abs(deltaX) > 5 || Math.abs(deltaY) > 5 && !isHolding) {
                    clearHoldTimer();
                }
                
                if (isHolding) {
                    // Pokud je aktivní podržení, aktualizovat pozici křížku
                    updateCrossMarkerPosition(e.touches[0].clientX, e.touches[0].clientY);
                } else {
                    // Jinak standardní posun plátna
                    offsetX += deltaX;
                    offsetY += deltaY;
                    lastX = e.touches[0].clientX;
                    lastY = e.touches[0].clientY;
                    drawGrid();
                }
            }
            
            // Aktualizovat zobrazení souřadnic
            if (e.touches.length > 0 && !isHolding) {
                const rawX = (e.touches[0].clientX - offsetX) / scale;
                const rawY = -(e.touches[0].clientY - offsetY) / scale;
                const gridX = parseFloat(rawX.toFixed(3)).toString();
                const gridY = parseFloat(rawY.toFixed(3)).toString();
                
                coordDisplay.textContent = `X: ${gridX}, Z: ${gridY}`;
            }
        });
        
        // Přidat touchend event handler
        canvas.addEventListener('touchend', (e) => {
            // Reset pinch-to-zoom variables when touch ends
            initialPinchDistance = 0;
            
            // Pokud není žádný prst na obrazovce, resetovat všechna stavy
            if (e.touches.length === 0) {
                isDragging = false;
                isHolding = false;
                clearHoldTimer();
                crossMarker.style.display = 'none';
            }
            
            // Pokud zůstal jeden prst, aktualizovat pozici
            if (e.touches.length === 1) {
                lastX = e.touches[0].clientX;
                lastY = e.touches[0].clientY;
                
                // Resetovat stav držení při změně počtu prstů
                isHolding = false;
                clearHoldTimer();
                crossMarker.style.display = 'none';
                
                // Začít nový odpočet pro podržení
                startHoldTimer(e.touches[0].clientX, e.touches[0].clientY);
            }
        });
        
        // Přidat touchcancel event pro úplnost
        canvas.addEventListener('touchcancel', () => {
            isDragging = false;
            isHolding = false;
            clearHoldTimer();
            crossMarker.style.display = 'none';
            initialPinchDistance = 0;
        });
        
        // Funkce pro výpočet vzdálenosti mezi dvěma dotyky
        function getPinchDistance(touches) {
            const dx = touches[0].clientX - touches[1].clientX;
            const dy = touches[0].clientY - touches[1].clientY;
            return Math.sqrt(dx * dx + dy * dy);
        }
        
        // Funkce pro výpočet středu mezi dvěma dotyky
        function getPinchCenter(touches) {
            return {
                x: (touches[0].clientX + touches[1].clientX) / 2,
                y: (touches[0].clientY + touches[1].clientY) / 2
            };
        }
        
        // Funkce pro práci s křížkem při podržení
        function startHoldTimer(x, y) {
            clearHoldTimer(); // Vyčistit existující časovač
            
            holdTimer = setTimeout(() => {
                isHolding = true;
                crossMarker.style.display = 'block';
                updateCrossMarkerPosition(x, y);
            }, holdDuration);
        }
        
        function clearHoldTimer() {
            if (holdTimer) {
                clearTimeout(holdTimer);
                holdTimer = null;
            }
        }
        
        function hideCrossMarker() {
            // Vždy resetovat stav držení a skrýt křížek
            isHolding = false;
            crossMarker.style.display = 'none';
        }
        
        function updateCrossMarkerPosition(x, y) {
            // Použít stejný offset 80px pro všechna zařízení
            const markerOffsetY = 80;
            
            // Aktualizovat pozici křížku - křížek je jen vizuální pomůcka
            // a je posunutý nad prst/myš
            const markerX = x;
            const markerY = y - markerOffsetY;
            crossMarker.style.left = `${markerX}px`;
            crossMarker.style.top = `${markerY}px`;
            
            // Výpočet souřadnic PRO POZICI KŘÍŽKU (ne pro pozici myši/prstu)
            const rawX = (markerX - offsetX) / scale;
            const rawY = -(markerY - offsetY) / scale;
            
            // Zaokrouhlit na 3 desetinná místa a pak zobrazit
            const gridX = parseFloat(rawX.toFixed(3)).toString();
            const gridY = parseFloat(rawY.toFixed(3)).toString();
            
            // Aktualizovat zobrazení souřadnic - použít souřadnice křížku
            coordDisplay.textContent = `X: ${gridX}, Z: ${gridY}`;
            
            // Pro účely ladění
            debugDisplay.style.display = 'none';
            // debugDisplay.innerHTML = `
            //     Pozice myši/prstu: x=${x}, y=${y}<br>
            //     Pozice křížku: x=${markerX}, y=${markerY}<br>
            //     Offset: offsetX=${offsetX}, offsetY=${offsetY}<br>
            //     Scale: ${scale}<br>
            //     Výpočet X: (${markerX} - ${offsetX}) / ${scale} = ${gridX}<br>
            //     Výpočet Z: -(${markerY} - ${offsetY}) / ${scale} = ${gridY}
            // `;
        }

        // Ovládání vysouvacího panelu
        const panelToggle = document.getElementById('panel-toggle');
        const slidingPanel = document.getElementById('sliding-panel');
        const canvasContainer = document.getElementById('canvas-container');
        const controls = document.querySelector('.controls'); // Přidán výběr controls
        const playbackControls = document.getElementById('playback-controls');
        let isPanelOpen = false;

        panelToggle.addEventListener('click', () => {
            isPanelOpen = !isPanelOpen;
            const height = slidingPanel.offsetHeight;
            root.style.setProperty('--panel-height', `${height}px`);
            slidingPanel.classList.toggle('open');
            canvasContainer.classList.toggle('panel-open');
            controls.classList.toggle('panel-open'); // Přidat zpět transformaci controls
            playbackControls.classList.toggle('panel-open'); // Přidat transformaci pro playback controls
        });

        // Přidat nový kód pro resize panelu
        const panelHandle = document.getElementById('panel-handle');
        const root = document.documentElement;
        let startY;
        let startHeight;

        function initPanelResize() {
            panelHandle.addEventListener('mousedown', startResize);
            document.addEventListener('mousemove', resize);
            document.addEventListener('mouseup', stopResize);
        }

        function startResize(e) {
            startY = e.clientY;
            startHeight = slidingPanel.offsetHeight;
            document.body.style.cursor = 'row-resize';
            e.preventDefault();
        }

        function resize(e) {
            if (startY) {
                const delta = startY - e.clientY;
                const newHeight = Math.min(Math.max(startHeight + delta, 200), window.innerHeight * 0.9);
                slidingPanel.style.height = `${newHeight}px`;
                root.style.setProperty('--panel-height', `${newHeight}px`);

                if (isPanelOpen) {
                    slidingPanel.style.bottom = `-${newHeight}px`;
                }
            }
        }

        function stopResize() {
            startY = null;
            document.body.style.cursor = '';
        }

        // Inicializovat resize funkcionalitu
        initPanelResize();

        // Přidat před inicializaci panel resize
        const playPauseBtn = document.getElementById('play-pause');
        const stepBackwardBtn = document.getElementById('step-backward');
        const stepForwardBtn = document.getElementById('step-forward');
        const stopBtn = document.getElementById('stop');
        const speedDownBtn = document.getElementById('speed-down');
        const speedUpBtn = document.getElementById('speed-up');
        const speedResetBtn = document.getElementById('speed-reset');
        const speedDisplay = document.getElementById('speed-display');

        let isPlaying = false;
        let playbackSpeed = 1;

        // Funkce pro ovládání přehrávače
        playPauseBtn.addEventListener('click', () => {
            isPlaying = !isPlaying;
            playPauseBtn.textContent = isPlaying ? '⏸' : '▶';
            // TODO: Implementovat logiku přehrávání
        });

        stopBtn.addEventListener('click', () => {
            isPlaying = false;
            playPauseBtn.textContent = '▶';
            // TODO: Implementovat logiku zastavení
        });

        stepBackwardBtn.addEventListener('click', () => {
            // TODO: Implementovat logiku kroku vzad
        });

        stepForwardBtn.addEventListener('click', () => {
            // TODO: Implementovat logiku kroku vpřed
        });

        speedUpBtn.addEventListener('click', () => {
            playbackSpeed = Math.min(playbackSpeed * 2, 16);
            speedDisplay.textContent = playbackSpeed + '×';
        });

        speedDownBtn.addEventListener('click', () => {
            playbackSpeed = Math.max(playbackSpeed / 2, 0.25);
            speedDisplay.textContent = playbackSpeed + '×';
        });

        speedResetBtn.addEventListener('click', () => {
            playbackSpeed = 1;
            speedDisplay.textContent = '1×';
        });

        // Controls toggle functionality
        const controlsToggleBtn = document.getElementById('controls-toggle');
        const controlsPanel = document.querySelector('.controls');
        let controlsVisible = true;
        
        controlsToggleBtn.addEventListener('click', () => {
            controlsVisible = !controlsVisible;
            controlsPanel.classList.toggle('hidden', !controlsVisible);
        });

        // Přidat novou funkčnost pro tlačítko zobrazení/skrytí ovládání
        const controlsVisibilityBtn = document.getElementById('controls-visibility');
        if (controlsVisibilityBtn) {
            controlsVisibilityBtn.addEventListener('click', () => {
                controlsPanel.classList.toggle('hidden');
            });
        }
    </script>
</body>
</html>
