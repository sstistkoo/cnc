<!DOCTYPE html>
<html lang="cs">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CNC Parser a Editor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            height: 100vh;
            overflow: hidden;
            touch-action: none;
            font-family: Arial, sans-serif;
        }

        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            background-color: #f3f4f6;
        }

        .editor {
            background-color: white;
            overflow: hidden;
            position: relative;
        }

        .editor-label {
            position: absolute;
            top: 0;
            right: 8px;
            padding: 4px 8px 8px;
            background-color: #e5e7eb;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 12px;
            color: #374151;
            z-index: 10;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 60px;
        }

        .editor-label::after {
            content: '';
            margin-top: 8px;
            width: 24px;
            height: 4px;
            background-color: #6b7280;
            border-radius: 9999px;
            box-shadow: 0 6px 0 #6b7280;
        }

        .editor-label:hover {
            background-color: #d1d5db;
        }

        .editor textarea {
            width: 100%;
            height: 100%;
            resize: none;
            border: 1px solid #d1d5db;
            padding: 1.5rem 1rem 1rem;
            font-size: 1rem;
            font-family: monospace;
        }

        #topEditor {
            position: relative;
            z-index: 1;
        }

        #bottomEditor {
            position: relative;
            z-index: 1001;
            visibility: visible;
            min-height: 5vh;
            /* Minimální výška pro mobilní zařízení */
        }

        @media (max-width: 768px) {
            #bottomEditor {
                min-height: 20vh;
                /* Větší minimální výška na mobilních zařízeních */
            }
        }

        .middle-window {
            background-color: #e5e7eb;
            position: relative;
            overflow: hidden;
            transition: height 0.3s ease-in-out;
            border-top: 1px solid #d1d5db;
            border-bottom: 1px solid #d1d5db;
        }

        .middle-content {
            height: 100%;
            padding: 0.5rem;
            display: flex;
            align-items: center;
            transition: opacity 0.3s;
        }

        .middle-content.hidden {
            opacity: 0;
        }

        .square-button {
            width: 45px;
            height: 45px;
            background-color: #64748b;
            color: white;
            border: none;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            cursor: pointer;
            margin: 0 10px;
        }

        .square-button:hover {
            background-color: #475569;
        }

        .file-icon {
            width: 50px;
            height: 50px;
            cursor: pointer;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0 auto;
            background-color: #f3f4f6;
            padding: 10px;
            border-radius: 8px;
            border: 2px dashed #d1d5db;
        }

        .file-icon svg {
            width: 24px;
            height: 24px;
            color: #374151;
        }

        .file-icon:hover {
            background-color: #e5e7eb;
            border-color: #9ca3af;
        }

        .file-icon:hover svg {
            color: #1f2937;
        }

        .file-icon span {
            font-size: 12px;
            margin-top: 5px;
            text-align: center;
            color: #374151;
        }

        .file-input {
            display: none;
        }

        .side-panel {
            position: fixed;
            top: 0;
            height: 100vh;
            width: 300px;
            background-color: white;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease-in-out;
            z-index: 1001;
        }

        .left-panel {
            left: 0;
            transform: translateX(-100%);
        }

        .right-panel {
            right: 0;
            transform: translateX(100%);
        }

        .side-panel.open {
            transform: translateX(0);
        }

        .close-button {
            position: absolute;
            top: 10px;
            width: 30px;
            height: 30px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 24px;
            color: #374151;
            display: flex;
            align-items: center;
            justify-content: center;
            right: 10px;
            /* Změna pozice křížku */
        }

        .left-panel .close-button {
            right: 10px;
        }

        .right-panel .close-button {
            left: 10px;
        }

        .top-panel {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: auto;
            background-color: white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transform: translateY(0);
            /* Změněno z translateY(-100%) na 0 */
            transition: transform 0.3s ease-in-out;
            z-index: 1001;
            padding: 0;
            min-height: 45px;
            /* Minimální výška pro zobrazení ovládacích prvků */
        }

        .top-panel.hidden {
            transform: translateY(-100%);
        }

        .top-panel.open {
            transform: translateY(0);
        }

        .program-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            padding: 5px 10px;
            overflow-y: visible;
            flex: 1;
            height: 45px;
            align-items: center;
        }

        .program-item {
            height: 35px;
            display: flex;
            align-items: center;
            padding: 0 1rem;
            background-color: #f3f4f6;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            cursor: pointer;
            white-space: nowrap;
            font-size: 0.9rem;
        }

        .program-item:hover {
            background-color: #e5e7eb;
        }

        .top-panel-controls {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            padding: 5px 15px;
            height: 45px;
            gap: 15px;
            /* Mezera mezi ikonami */
            border-left: 1px solid #e5e7eb;
            background-color: white;
        }

        .freeze-button {
            width: 35px;
            height: 35px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0;
            /* Odstranění margin */
            position: relative;
            /* Přidáno pro konzistenci */
        }

        .close-button {
            position: relative;
            /* Změna z absolute na relative */
            top: auto;
            /* Odstranění absolute pozicování */
            right: auto;
            /* Odstranění absolute pozicování */
            width: 35px;
            height: 35px;
            font-size: 28px;
        }

        .freeze-button svg {
            width: 24px;
            height: 24px;
        }

        .close-button {
            width: 35px;
            height: 35px;
            font-size: 28px;
            /* Větší křížek */
        }

        /* Odstraníme margin-right, protože používáme gap v parent elementu */
        .freeze-button {
            margin-right: 0;
        }

        .freeze-button span {
            display: none;
            /* Skryjeme text */
        }

        .freeze-button.active {
            color: #2563eb;
        }

        .program-item.active {
            background-color: #60a5fa;
            color: white;
            border-color: #3b82f6;
        }

        .program-item.active:hover {
            background-color: #3b82f6;
        }

        /* Přidat nový wrapper pro flex layout */
        .top-panel-wrapper {
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 45px;
        }

        /* Přidáme styl pro aktivní tlačítko v middle-window */
        .square-button.active {
            background-color: #3b82f6;
            /* Modré pozadí */
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.3);
            /* Vnitřní stín */
        }

        /* Přidáme vylepšené styly pro SVG ikony v tlačítkách */
        .square-button svg {
            width: 24px;
            height: 24px;
            stroke: currentColor;
            stroke-width: 2;
            fill: none;
        }

        /* Zvýrazníme tlačítka pro ukládání/načítání jinými barvami */
        #saveButton {
            background-color: rgba(76, 175, 80, 0.7);
            /* Zelená barva */
        }

        #loadJsonButton {
            background-color: rgba(33, 150, 243, 0.7);
            /* Modrá barva */
        }

        #saveJsonButton {
            background-color: rgba(156, 39, 176, 0.7);
            /* Fialová barva */
        }

        /* Efekty při najetí na tlačítka */
        #saveButton:hover {
            background-color: rgba(76, 175, 80, 0.9);
        }

        #loadJsonButton:hover {
            background-color: rgba(33, 150, 243, 0.9);
        }

        #saveJsonButton:hover {
            background-color: rgba(156, 39, 176, 0.9);
        }

        /* Přidáme styl pro tlačítko Parse v horním panelu */
        .parse-button {
            height: 35px;
            padding: 0 15px;
            margin-right: 15px;
            background-color: #4285f4;
            color: white;
            border: none;
            border-radius: 4px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
        }

        .parse-button:hover {
            background-color: #3367d6;
        }

        /* Styl pro tlačítko konzole */
        .console-button {
            height: 35px;
            padding: 0 15px;
            margin-right: 15px;
            background-color: #ff6b6b;
            color: white;
            border: none;
            border-radius: 4px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
        }

        .console-button:hover {
            background-color: #e84a4a;
        }

        /* Skryté okno konzole */
        .mobile-console {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 50vh;
            background: rgba(30, 30, 30, 0.95);
            color: white;
            z-index: 2000;
            font-family: monospace;
            flex-direction: column;
            border-top: 2px solid #ff6b6b;
        }

        .mobile-console.open {
            display: flex;
        }

        .mobile-console-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 15px;
            background: #333;
            border-bottom: 1px solid #555;
        }

        .mobile-console-content {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            font-size: 14px;
            line-height: 1.4;
        }

        .mobile-console-close {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
        }

        .log-entry {
            margin-bottom: 8px;
            border-bottom: 1px solid #444;
            padding-bottom: 5px;
        }

        .log-entry.error {
            color: #ff6b6b;
        }

        .log-entry.warn {
            color: #ffb347;
        }

        .log-entry.info {
            color: #63c5da;
        }

        /* Styly pro levý panel */
        .panel-content {
            padding: 15px;
            overflow-y: auto;
            height: calc(100% - 50px);
        }

        .panel-title {
            margin: 0 0 15px 0;
            font-size: 1.2rem;
            color: #2563eb;
            padding-bottom: 8px;
            border-bottom: 1px solid #e5e7eb;
        }

        .panel-section {
            margin-bottom: 20px;
        }

        .panel-section h4 {
            margin: 0 0 10px 0;
            font-size: 1rem;
            color: #4b5563;
        }

        .panel-buttons {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .panel-button {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background-color: #f3f4f6;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .panel-button:hover {
            background-color: #e5e7eb;
        }

        .panel-button svg {
            width: 18px;
            height: 18px;
            color: #4b5563;
        }

        .panel-button span {
            font-size: 0.9rem;
            color: #374151;
        }

        .active-program-info {
            background-color: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            padding: 12px;
        }

        .active-program-info .no-program {
            color: #9ca3af;
            font-style: italic;
        }

        .active-program-info .program-name {
            font-weight: bold;
            color: #2563eb;
            margin-bottom: 5px;
        }

        .active-program-info .program-meta {
            font-size: 0.8rem;
            color: #6b7280;
        }
    </style>
</head>

<body>
    <div class="container">
        <div id="topPanel" class="top-panel open">
            <div class="top-panel-wrapper">
                <div id="programList" class="program-list">
                    <!-- Programy budou dynamicky přidány zde -->
                </div>
                <div class="top-panel-controls">
                    <!-- Tlačítko pro skrytí/zobrazení panelu -->
                    <button id="toggleTopPanelBtn" class="close-button" onclick="toggleTopPanel()">×</button>
                </div>
            </div>
        </div>

        <div id="topEditor" class="editor">
            <iframe src="./okno_simulator.html" style="width: 100%; height: 100%; border: none;"
                id="simulatorFrame"></iframe>
        </div>

        <div class="middle-window" id="middleWindow">
            <div class="middle-content">
                <!-- Tlačítko LP zůstane první vlevo -->
                <button id="lpButton" class="square-button">LP</button>

                <!-- Odstraníme původní tlačítka a ponecháme pouze input element -->
                <input type="file" id="fileInput" class="file-input" accept=".mpf,.spf,.nc,.cnc" multiple />

                <!-- Volný prostor uprostřed -->
                <div style="flex: 1;"></div>

                <!-- Přidaná tlačítka pro parametry a parsované řádky zůstávají -->
                <button id="parametersButton" class="square-button" title="Zobrazit parametry">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20h9"></path><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path></svg>
                </button>

                <button id="parseModalButton" class="square-button" title="Parsované řádky">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"></path><rect x="8" y="8" width="8" height="8" rx="1"></rect></svg>
                </button>

                <button id="simulatorButton" class="square-button" title="Seznam programů">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M4 6h16M4 12h16M4 18h16" />
                    </svg>
                </button>

                <!-- Přesunuto úplně doprava -->
                <button id="ppButton" class="square-button">PP</button>
            </div>
        </div>

        <div id="bottomEditor" class="editor">
            <div class="editor-label" id="editorHandle">Menu</div>
            <textarea placeholder="Editor CNC kód..."></textarea>
        </div>
    </div>

    <div id="leftPanel" class="side-panel left-panel">
        <button class="close-button" onclick="toggleLeftPanel()">×</button>

        <!-- Přidaný nový obsah levého panelu -->
        <div class="panel-content">
            <h3 class="panel-title">Správa programů</h3>

            <div class="panel-section">
                <h4>CNC programy</h4>
                <div class="panel-buttons">
                    <button id="loadCncButtonPanel" class="panel-button" title="Načíst CNC programy">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" />
                            <line x1="12" y1="11" x2="12" y2="17" />
                            <polyline points="9 14 12 17 15 14" />
                        </svg>
                        <span>Načíst CNC soubory</span>
                    </button>

                    <button id="saveButtonPanel" class="panel-button" title="Uložit aktuální program">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" />
                            <line x1="12" y1="17" x2="12" y2="11" />
                            <polyline points="9 14 12 17 15 14" />
                        </svg>
                        <span>Uložit aktuální program</span>
                    </button>
                </div>
            </div>

            <div class="panel-section">
                <h4>JSON programy</h4>
                <div class="panel-buttons">
                    <button id="loadJsonButtonPanel" class="panel-button" title="Načíst programy z JSON">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" />
                            <polyline points="9 11 12 8 15 11" />
                            <line x1="12" y1="16" x2="12" y2="8" />
                            <rect x="7" y="19" width="10" height="1" rx="0.5" />
                            <circle cx="12" cy="19" r="1" />
                        </svg>
                        <span>Načíst programy z JSON</span>
                    </button>

                    <button id="saveJsonButtonPanel" class="panel-button" title="Uložit programy do JSON">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" />
                            <polyline points="9 15 12 18 15 15" />
                            <line x1="12" y1="8" x2="12" y2="18" />
                            <rect x="7" y="19" width="10" height="1" rx="0.5" />
                            <circle cx="12" cy="19" r="1" />
                        </svg>
                        <span>Uložit programy do JSON</span>
                    </button>
                </div>
            </div>

            <div class="panel-section">
                <h4>Aktivní program</h4>
                <div id="activeProgram" class="active-program-info">
                    <p class="no-program">Žádný aktivní program</p>
                </div>
            </div>
        </div>
    </div>

    <div id="rightPanel" class="side-panel right-panel">
        <button class="close-button" onclick="toggleRightPanel()">×</button>
    </div>

    <div id="mobileConsole" class="mobile-console">
        <div class="mobile-console-header">
            <span>Konzole</span>
            <button class="mobile-console-close" onclick="toggleMobileConsole()">×</button>
        </div>
        <div id="mobileConsoleContent" class="mobile-console-content">
            <!-- Sem se budou přidávat logy z konzole -->
        </div>
    </div>

    <script>
        const container = document.querySelector('.container');
        const topEditor = document.getElementById('topEditor');
        const middleWindow = document.getElementById('middleWindow');
        const bottomEditor = document.getElementById('bottomEditor');
        const middleContent = document.querySelector('.middle-content');
        const fileInput = document.getElementById('fileInput');
        const parserTextarea = topEditor.querySelector('textarea');
        const editorTextarea = bottomEditor.querySelector('textarea');
        const leftPanel = document.getElementById('leftPanel');
        const rightPanel = document.getElementById('rightPanel');
        const lpButton = document.getElementById('lpButton');
        const ppButton = document.getElementById('ppButton');
        const topPanel = document.getElementById('topPanel');
        const editorHandle = document.getElementById('editorHandle');
        let isMiddleOpen = false;
        let isDragging = false;
        let startY, startTopHeight, startBottomHeight;
        const MIDDLE_HEIGHT = 10;
        let topHeight = 95;
        let bottomHeight = 5;

        function updateHeights() {
            const middleHeight = isMiddleOpen ? MIDDLE_HEIGHT : 1;
            topEditor.style.height = `${topHeight}vh`;
            middleWindow.style.height = `${middleHeight}vh`;
            bottomEditor.style.height = `${bottomHeight}vh`;

            // Pouze zajistíme, že na mobilních zařízeních bude editor viditelný
            if (window.innerWidth <= 768 && isMiddleOpen) {
                bottomEditor.style.display = 'block'; // Zajistí, že editor bude viditelný
            }

            middleContent.classList.toggle('hidden', !isMiddleOpen);
        }

        // Přidáme ResizeObserver pro lepší aktualizaci pozice
        const resizeObserver = new ResizeObserver(() => {
            requestAnimationFrame(updateHeights);
        });

        resizeObserver.observe(document.body);
        resizeObserver.observe(topPanel);
        resizeObserver.observe(middleWindow);
        resizeObserver.observe(bottomEditor);

        editorHandle.addEventListener('click', (e) => {
            if (isDragging) return;

            e.stopPropagation();
            isMiddleOpen = !isMiddleOpen;

            if (isMiddleOpen) {
                const availableSpace = 100 - MIDDLE_HEIGHT;
                const ratio = topHeight / (topHeight + bottomHeight);
                topHeight = availableSpace * ratio;
                bottomHeight = availableSpace * (1 - ratio);
            } else {
                const ratio = topHeight / (topHeight + bottomHeight);
                topHeight = 99 * ratio;
                bottomHeight = 99 * (1 - ratio);
            }

            updateHeights();

            // Aktualizace čísel řádků - použijeme původní kód, který fungoval
            const editorTextarea = document.querySelector('#bottomEditor textarea');
            if (editorTextarea) {
                // Odložit aktualizaci, aby proběhla po dokončení animace
                setTimeout(() => {
                    // Znovu inicializovat číslování řádků
                    const lineNumbers = document.querySelector('.line-numbers');
                    if (lineNumbers) {
                        lineNumbers.scrollTop = editorTextarea.scrollTop;
                        lineNumbers.style.height = `${editorTextarea.clientHeight}px`;
                    }
                }, 300);
            }
        });

        editorHandle.addEventListener('touchstart', (e) => {
            isDragging = true;
            startY = e.touches[0].clientY;
            startTopHeight = topHeight;
            startBottomHeight = bottomHeight;
        });

        document.addEventListener('touchmove', (e) => {
            if (!isDragging) return;

            const touch = e.touches[0];
            const deltaY = touch.clientY - startY;
            const deltaPercent = (deltaY / window.innerHeight) * 100;

            const availableSpace = 100 - (isMiddleOpen ? MIDDLE_HEIGHT : 1);
            const newTopHeight = Math.max(20, Math.min(availableSpace - 20, startTopHeight + deltaPercent));
            const newBottomHeight = availableSpace - newTopHeight;

            if (newBottomHeight >= 20) {
                topHeight = newTopHeight;
                bottomHeight = newBottomHeight;
                updateHeights();
            }
        }, { passive: false });

        document.addEventListener('touchend', () => {
            isDragging = false;
        });

        editorHandle.addEventListener('mousedown', (e) => {
            isDragging = true;
            startY = e.clientY;
            startTopHeight = topHeight;
            startBottomHeight = bottomHeight;

            // Zabránit propagaci události
            e.stopPropagation();
        });

        document.addEventListener('mousemove', (e) => {
            if (!isDragging) return;

            const deltaY = e.clientY - startY;
            const deltaPercent = (deltaY / window.innerHeight) * 100;

            const availableSpace = 100 - (isMiddleOpen ? MIDDLE_HEIGHT : 1);
            const newTopHeight = Math.max(20, Math.min(availableSpace - 20, startTopHeight + deltaPercent));
            const newBottomHeight = availableSpace - newTopHeight;

            if (newBottomHeight >= 20) {
                topHeight = newTopHeight;
                bottomHeight = newBottomHeight;
                updateHeights();
            }
        });

        document.addEventListener('mouseup', () => {
            isDragging = false;
        });

        // Naslouchání na zprávy z iframe (okno_simulator.html)
        window.addEventListener('message', (event) => {
            // Kontrola, zda zpráva obsahuje akci toggleMenu
            if (event.data && event.data.action === 'toggleMenu') {
                // Aktivace stejné funkce jako při kliknutí na tlačítko Menu
                editorHandle.click();
            }
        });

        function adjustHeightsForTopPanel(isOpen) {
            if (isOpen) {
                originalTopHeight = topHeight;
                originalBottomHeight = bottomHeight;

                const programList = document.getElementById('programList');
                const items = programList.children;

                // Konstanty pro výpočet výšky
                const controlsHeight = 45; // Výška panelu s ovládacími prvky
                const itemPadding = 10;    // Padding pro položky

                // Výpočet skutečné šířky dostupné pro položky
                const availableWidth = window.innerWidth - 150; // Odečteme prostor pro controls
                const itemWidth = 150;      // Přibližná šířka jedné položky
                const itemsPerRow = Math.floor(availableWidth / itemWidth);
                const rows = Math.ceil(items.length / itemsPerRow) || 1;

                // Vypočítáme celkovou výšku - pokud je jeden řádek, použijeme controlsHeight
                const panelHeight = rows === 1 ? controlsHeight : controlsHeight * rows;

                topPanel.style.height = `${panelHeight}px`;
                container.style.marginTop = `${panelHeight}px`;

                const reduction = (panelHeight / window.innerHeight) * 100;
                const ratio = topHeight / (topHeight + bottomHeight);
                const availableSpace = 100 - reduction;

                topHeight = availableSpace * ratio;
                bottomHeight = availableSpace * (1 - ratio);
            } else {
                if (originalTopHeight && originalBottomHeight) {
                    topHeight = originalTopHeight;
                    bottomHeight = originalBottomHeight;
                }
                container.style.marginTop = '0';
            }
            updateHeights();
        }

        function toggleTopPanel() {
            const topPanel = document.getElementById('topPanel');
            const container = document.querySelector('.container');
            const simulatorButton = document.getElementById('simulatorButton');
            const toggleBtn = document.getElementById('toggleTopPanelBtn');

            // Zjistíme aktuální stav panelu - důležité je použít třídu "hidden", ne "open"
            const isHidden = topPanel.classList.contains('hidden');

            if (isHidden) {
                // Panel je skrytý a chceme ho zobrazit
                topPanel.classList.remove('hidden');

                // Uložit původní výšky, pokud existují
                if (typeof originalTopHeight !== 'undefined' && typeof originalBottomHeight !== 'undefined') {
                    topHeight = originalTopHeight;
                    bottomHeight = originalBottomHeight;
                }

                // Přizpůsobit výšku panelu podle počtu programů
                const programList = document.getElementById('programList');
                const items = programList.children;
                const controlsHeight = 45;
                const availableWidth = window.innerWidth - 150;
                const itemWidth = 150;
                const itemsPerRow = Math.floor(availableWidth / itemWidth);
                const rows = Math.ceil(items.length / itemsPerRow) || 1;
                const panelHeight = rows === 1 ? controlsHeight : controlsHeight * rows;

                // Nastavit výšku panelu a odsazení kontejneru
                topPanel.style.height = `${panelHeight}px`;
                container.style.marginTop = `${panelHeight}px`;

                // Upravit výšky editorů
                const reduction = (panelHeight / window.innerHeight) * 100;
                const ratio = topHeight / (topHeight + bottomHeight);
                const availableSpace = 100 - reduction;
                topHeight = availableSpace * ratio;
                bottomHeight = availableSpace * (1 - ratio);

                // Aktualizovat tlačítko
                if (toggleBtn) toggleBtn.textContent = '×';

                // Aktualizovat stav tlačítka simulátoru
                if (simulatorButton) {
                    simulatorButton.classList.add('active');
                    simulatorButton.title = "Skrýt seznam programů";
                }
            } else {
                // Panel je viditelný a chceme ho skrýt
                topPanel.classList.add('hidden');

                // Uložit aktuální výšky pro pozdější obnovení
                originalTopHeight = topHeight;
                originalBottomHeight = bottomHeight;

                // Resetovat margin kontejneru
                container.style.marginTop = '0';

                // Aktualizovat tlačítko
                if (toggleBtn) toggleBtn.textContent = '↓';

                // Aktualizovat stav tlačítka simulátoru
                if (simulatorButton) {
                    simulatorButton.classList.remove('active');
                    simulatorButton.title = "Zobrazit seznam programů";
                }
            }

            // Aktualizovat výšky všech elementů
            updateHeights();
        }

        function toggleLeftPanel() {
            leftPanel.classList.toggle('open');
        }

        function toggleRightPanel() {
            rightPanel.classList.toggle('open');
        }

        lpButton.addEventListener('click', toggleLeftPanel);
        ppButton.addEventListener('click', toggleRightPanel);

        document.addEventListener('click', (e) => {
            if (leftPanel.classList.contains('open') &&
                !leftPanel.contains(e.target) &&
                e.target !== lpButton) {
                toggleLeftPanel();
            }
            if (rightPanel.classList.contains('open') &&
                !rightPanel.contains(e.target) &&
                e.target !== ppButton) {
                toggleRightPanel();
            }
        });

        const isPanelFrozen = true; // Panel zůstává vždy otevřený

        // Přidat nastavení třídy active hned po načtení DOM
        document.addEventListener('DOMContentLoaded', () => {
            // Místo toho přejdeme přímo k načtení CNC programu
            loadCNCProgramFromJSON();

            // Přidáme správný event listener pro tlačítko konzole
            const consoleButton = document.getElementById('consoleButton');
            if (consoleButton) {
                consoleButton.addEventListener('click', toggleMobileConsole);
            }

            // Inicializace přesměrování konzolového výstupu
            setupMobileConsoleOutput();

            // NOVÝ KÓD - Kompletní restart všech handlerů pro editorHandle
            const editorHandle = document.getElementById('editorHandle');
            if (editorHandle) {
                console.log('Úplné vyčištění a restart všech event handlerů pro Menu tlačítko');

                // Vytvořit úplně nový element místo původního (zajistí odstranění všech event handlerů)
                const newEditorHandle = editorHandle.cloneNode(true);
                editorHandle.parentNode.replaceChild(newEditorHandle, editorHandle);

                // Přidat JEDINÝ správný event handler pro kliknutí
                newEditorHandle.addEventListener('click', function (e) {
                    console.log('Menu tlačítko kliknuto - spouštím alternativní handler');
                    e.preventDefault();
                    e.stopPropagation();

                    // Základní logika přepínání
                    isMiddleOpen = !isMiddleOpen;

                    if (isMiddleOpen) {
                        console.log('Otevírám panel editoru');
                        const availableSpace = 100 - MIDDLE_HEIGHT;
                        topHeight = availableSpace * 0.7; // 70% horní panel
                        bottomHeight = availableSpace * 0.3; // 30% dolní panel
                    } else {
                        console.log('Zavírám panel editoru');
                        topHeight = 99;
                        bottomHeight = 1;
                    }

                    // Aktualizovat výšky elementů
                    topEditor.style.height = `${topHeight}vh`;
                    middleWindow.style.height = `${isMiddleOpen ? MIDDLE_HEIGHT : 1}vh`;
                    bottomEditor.style.height = `${bottomHeight}vh`;
                    middleContent.classList.toggle('hidden', !isMiddleOpen);

                    // Zajistit, že číslování řádků bude fungovat
                    setTimeout(function () {
                        // Vytvořit číslování řádků od začátku
                        setupSimpleLineNumbers();
                    }, 300);
                });

                // Přidat správný handler pro mousedown - POUZE pro tažení
                newEditorHandle.addEventListener('mousedown', function (e) {
                    // Pouze pokud se jedná o levé tlačítko myši (hlavní tlačítko)
                    if (e.button === 0) {
                        console.log('Menu mousedown - spouštím tažení');
                        isDragging = true;
                        startY = e.clientY;
                        startTopHeight = topHeight;
                        startBottomHeight = bottomHeight;
                        e.preventDefault();
                        e.stopPropagation();
                    }
                });
            }
        });

        // Přidat event listener pro změnu velikosti okna
        window.addEventListener('resize', () => {
            if (topPanel.classList.contains('open')) {
                adjustHeightsForTopPanel(true);
            }
        });

        window.addEventListener('resize', updateHeights);

        function openSimulator() {
            // Funkce pro otevření simulátoru v iframeu
            let simulatorFrame = document.getElementById('simulatorFrame');
            if (!simulatorFrame) {
                simulatorFrame = document.createElement('iframe');
                simulatorFrame.id = 'simulatorFrame';
                simulatorFrame.style.width = '100%';
                simulatorFrame.style.height = '100%';
                simulatorFrame.style.border = 'none';
                simulatorFrame.src = 'okno_simulator.html';
                // Vyčistíme obsah middle-window a vložíme iframe
                const middleContent = document.querySelector('.middle-content');
                middleContent.innerHTML = '';
                middleContent.appendChild(simulatorFrame);
                // Přidáme posluchač zpráv z iframe
                window.addEventListener('message', (event) => {
                    // Zde můžeme zpracovat zprávy ze simulátoru, pokud bude potřeba
                    console.log('Zpráva ze simulátoru:', event.data);
                });
            }
            // Zobrazíme middle-window, pokud je skryté
            middleWindow.style.height = '40%';
            middleContent.classList.remove('hidden');
            // Odešleme CNC kód do simulátoru
            const cncCode = editorTextarea.value;
            setTimeout(() => {
                simulatorFrame.contentWindow.postMessage({
                    type: 'loadCNCCode',
                    code: cncCode
                }, '*');
            }, 500); // Počkáme 500ms, aby se iframe stačil načíst
        }

        const simulatorButton = document.getElementById('simulatorButton');
        simulatorButton.onclick = function () {
            toggleTopPanel();
        };

        // Přidat novou funkci pro načtení CNC programu z JSON souboru
        function loadCNCProgramFromJSON() {
            console.log('Načítám CNC program z JSON souboru...');
            fetch('./program/K1_03_4431.json')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Soubor nebyl nalezen nebo nastala síťová chyba');
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Program načten:', data.name);
                    const programList = document.getElementById('programList');
                    // Vyčistit a znovu naplnit seznam programů
                    programList.innerHTML = '';
                    // Přidat programy do seznamu
                    const mainProgram = data.programs.find(p => p.type === 'MPF');
                    if (mainProgram) {
                        addProgramToList(mainProgram, programList, true);
                    }
                    data.programs.filter(p => p.type === 'SPF').forEach(program => {
                        addProgramToList(program, programList);
                    });
                    // Otevřít panel s programy
                    if (!topPanel.classList.contains('open')) {
                        topPanel.classList.add('open');
                        adjustHeightsForTopPanel(true);
                    }
                })
                .catch(error => {
                    console.error('Chyba při načítání CNC programu:', error);
                });
        }

        // Upravíme funkci addProgramToList pro použití parseru
        function addProgramToList(program, programList, activate = false) {
            const programItem = document.createElement('div');
            programItem.className = 'program-item';
            let displayName = program.name;
            // Odstranit příponu .spf z názvu, pokud existuje
            if (program.type === 'SPF' && displayName.toLowerCase().endsWith('.spf')) {
                displayName = displayName.substring(0, displayName.length - 4);
            }
            programItem.textContent = displayName;
            programItem.dataset.originalName = program.name; // Uchovat původní název pro odkazy
            programItem.dataset.code = program.code.join('\n');
            // Načíst kód programu do editoru
            programItem.onclick = () => {
                editorTextarea.value = programItem.dataset.code;
                // Zvýraznění aktivního programu
                if (activeProgram) {
                    activeProgram.classList.remove('active');
                }
                programItem.classList.add('active');
                activeProgram = programItem;

                // Panel se již automaticky nezavírá, odstraněna podmínka isPanelFrozen
                console.clear();
                console.log(`Parsování programu: ${program.name}`);
                import('./js/cnc-line-parser.js').then(module => {
                    const parsedProgram = module.parseProgram(programItem.dataset.code);

                    console.log(`Celkem ${parsedProgram.length} řádků parsováno`);
                    const typeCounts = {};
                    // Statistiky o typech řádků
                    parsedProgram.forEach(line => {
                        if (!typeCounts[line.type]) typeCounts[line.type] = 0;
                        typeCounts[line.type]++;
                    });
                    console.group('Statistika typů řádků');
                    Object.entries(typeCounts).sort((a, b) => b[1] - a[1]).forEach(([type, count]) => {
                        console.log(`${type}: ${count}`);
                    });
                    console.groupEnd();
                }).catch(error => {
                    console.error('Chyba při parsování programu:', error);
                });
            };
            programList.appendChild(programItem);

            // Pokud je označen jako aktivní, nastavit jako aktivní
            if (activate) {
                editorTextarea.value = programItem.dataset.code;
                programItem.classList.add('active');
                activeProgram = programItem;
            }
        }

        updateHeights();

        // Přidat nový event listener pro tlačítko Parse
        document.addEventListener('DOMContentLoaded', () => {
            // Existující kód...
            const middleContent = document.querySelector('.middle-content');
            // Přidat tlačítko Parse do middle-content
            if (middleContent) {
                const parseButton = document.createElement('button');
                parseButton.id = 'parseButton';
                parseButton.className = 'square-button';
                parseButton.innerHTML = 'Parse';
                parseButton.title = 'Parsovat aktuální kód';
                const simulatorButton = document.getElementById('simulatorButton');
                // Přidat tlačítko před simulatorButton
                if (simulatorButton) {
                    middleContent.insertBefore(parseButton, simulatorButton);
                } else {
                    middleContent.appendChild(parseButton);
                }
                // Přidat event listener pro tlačítko Parse
                parseButton.addEventListener('click', () => {
                    const codeContent = editorTextarea.value;
                    if (!codeContent || codeContent.trim() === '') {
                        console.warn('Žádný kód k parsování');
                        return;
                    }
                    console.clear();
                    console.log('%cParsování aktuálního kódu v editoru', 'color: green; font-size: 14px; font-weight: bold;');
                    import('./js/cnc-line-parser.js').then(module => {
                        const parsedProgram = module.parseProgram(codeContent);

                        console.log(`%cCelkem ${parsedProgram.length} řádků parsováno`, 'color: green; font-weight: bold;');
                        const typeCounts = {};
                        // Statistiky o typech řádků
                        parsedProgram.forEach(line => {
                            if (!typeCounts[line.type]) typeCounts[line.type] = 0;
                            typeCounts[line.type]++;
                        });
                        console.group('Statistika typů řádků');
                        Object.entries(typeCounts).sort((a, b) => b[1] - a[1]).forEach(([type, count]) => {
                            console.log(`${type}: ${count}`);
                        });
                        console.groupEnd();
                    }).catch(error => {
                        console.error('Chyba při parsování programu:', error);
                    });
                });
            }
        });

        // Funkce pro uložení aktuálního programu
        function saveCurrentProgram() {
            const programContent = editorTextarea.value;
            if (!programContent || programContent.trim() === '') {
                alert('Žádný obsah k uložení');
                return;
            }
            // Získat název souboru
            let filename = 'program.mpf';
            if (activeProgram) {
                filename = activeProgram.textContent;
            } else {
                const userFilename = prompt('Zadejte název souboru:', 'program.mpf');
                if (userFilename) {
                    filename = userFilename;
                    // Přidat příponu .mpf, pokud chybí
                    if (!filename.toLowerCase().endsWith('.mpf') && !filename.toLowerCase().endsWith('.spf')) {
                        filename += '.mpf';
                    }
                }
            }
            const blob = new Blob([programContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            // Uvolnit URL a odstranit element
            setTimeout(() => {
                URL.revokeObjectURL(url);
                document.body.removeChild(a);
            }, 100);
        }

        // Funkce pro načtení programů z JSON souboru
        function loadProgramsFromJson(jsonContent) {
            try {
                const data = JSON.parse(jsonContent);
                if (!data.programs || !Array.isArray(data.programs)) {
                    alert('Neplatný formát JSON souboru. Chybí pole "programs".');
                    return;
                }
                const programList = document.getElementById('programList');
                programList.innerHTML = '';
                // Přidat programy do seznamu
                const mainProgram = data.programs.find(p => p.type === 'MPF');
                if (mainProgram) {
                    addProgramToList(mainProgram, programList, true);
                }
                data.programs.filter(p => p.type === 'SPF').forEach(program => {
                    addProgramToList(program, programList);
                });
                if (programList.children.length > 0 && !topPanel.classList.contains('open')) {
                    topPanel.classList.add('open');
                    adjustHeightsForTopPanel(true);
                }
                console.log(`Načteno ${data.programs.length} programů z JSON souboru`);
            } catch (error) {
                console.error('Chyba při načítání JSON souboru:', error);
                alert('Chyba při načítání JSON souboru: ' + error.message);
            }
        }

        // Funkce pro uložení programů do JSON souboru
        function saveProgramsToJson() {
            const programList = document.getElementById('programList');
            const programItems = programList.querySelectorAll('.program-item');
            if (programItems.length === 0) {
                alert('Žádné programy k uložení');
                return;
            }
            const data = {
                name: "CNC_Programs_" + new Date().toISOString().split('T')[0],
                description: "Exportovaný soubor CNC programů",
                programs: []
            };
            programItems.forEach(item => {
                const name = item.textContent;
                const code = item.dataset.code || '';
                const type = name.toUpperCase().endsWith('.MPF') ? 'MPF' : 'SPF';
                data.programs.push({
                    name,
                    description: `Program ${name}`,
                    type,
                    code: code.split('\n')
                });
            });
            const jsonContent = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonContent], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = data.name + ".json";
            document.body.appendChild(a);
            a.click();
            // Uvolnit URL a odstranit element
            setTimeout(() => {
                URL.revokeObjectURL(url);
                document.body.removeChild(a);
            }, 100);
        }

        // Přidat event listenery pro nová tlačítka
        document.addEventListener('DOMContentLoaded', () => {
            // Existující kód...
            const saveButton = document.getElementById('saveButton');
            if (saveButton) {
                saveButton.addEventListener('click', () => {
                    saveCurrentProgram();
                });
            }
            const loadJsonButton = document.getElementById('loadJsonButton');
            if (loadJsonButton) {
                loadJsonButton.addEventListener('click', () => {
                    // Vytvořit neviditelný input pro výběr souboru
                    const jsonFileInput = document.createElement('input');
                    jsonFileInput.type = 'file';
                    jsonFileInput.accept = '.json';
                    jsonFileInput.style.display = 'none';
                    jsonFileInput.addEventListener('change', (e) => {
                        if (e.target.files.length > 0) {
                            const file = e.target.files[0];
                            const reader = new FileReader();
                            reader.onload = (event) => {
                                loadProgramsFromJson(event.target.result);
                            };
                            reader.readAsText(file);
                        }
                    });
                    jsonFileInput.click();
                    document.body.appendChild(jsonFileInput);
                    jsonFileInput.click();
                    document.body.removeChild(jsonFileInput);
                });
            }
            const saveJsonButton = document.getElementById('saveJsonButton');
            if (saveJsonButton) {
                saveJsonButton.addEventListener('click', () => {
                    saveProgramsToJson();
                });
            }
        });

        // Upravit styl editoru pro zobrazení čísel řádků
        document.addEventListener('DOMContentLoaded', () => {
            // Existující kód...
            // Přidání funkce pro očíslování řádků v editoru
            function addLineNumbers(textarea) {
                if (!textarea) return;

                const container = textarea.parentElement;
                // Vytvořit element pro čísla řádků, pokud ještě neexistuje
                let lineNumbers = container.querySelector('.line-numbers');
                if (!lineNumbers) {
                    lineNumbers = document.createElement('div');
                    lineNumbers.className = 'line-numbers';
                    container.insertBefore(lineNumbers, textarea);

                    // Přidáváme styly s pevným umístěním a pevnou šířkou
                    const style = document.createElement('style');
                    style.textContent = `
                        .editor {
                            position: relative;
                        }
                        .line-numbers {
                            position: absolute;
                            top: 1.5rem;
                            left: 0;
                            width: 40px;
                            height: calc(100% - 1.5rem);
                            padding: 1rem 0 1rem 5px;
                            background-color: #f5f5f5;
                            border-right: 1px solid #ddd;
                            font-family: monospace;
                            font-size: 1rem;
                            color: #777;
                            text-align: right;
                            z-index: 2;
                            user-select: none;
                            pointer-events: none;
                            overflow: hidden;
                            white-space: pre !important;
                            line-height: 1.5;
                            display: flex;
                            flex-direction: column;
                        }
                        .editor textarea {
                            padding-left: 45px !important;
                            line-height: 1.5;
                            font-family: monospace;
                            font-size: 1rem;
                            white-space: pre !important;
                            tab-size: 4;
                            -moz-tab-size: 4;
                            overflow-wrap: normal !important;
                            word-wrap: normal !important;
                        }
                    `;
                    document.head.appendChild(style);
                }

                // Upravená funkce pro aktualizaci čísel řádků
                function updateLineNumbers() {
                    const text = textarea.value;
                    const lines = text.split('\n');
                    lineNumbers.innerHTML = ''; // Vyčistit předchozí obsah
                    // Použijeme přístup, kde vytváříme jeden element pro každé číslo řádku
                    for (let i = 0; i < lines.length; i++) {
                        const lineNumber = document.createElement('div');
                        lineNumber.textContent = (i + 1).toString();
                        lineNumber.style.height = '1.5em'; // Výška jednoho řádku
                        lineNumbers.appendChild(lineNumber);
                    }
                    // Zajištění stejné výšky a synchronizace scrollu
                    lineNumbers.style.height = textarea.clientHeight + 'px';
                    lineNumbers.scrollTop = textarea.scrollTop;
                }

                // Inicializace a event listenery
                updateLineNumbers();
                textarea.addEventListener('input', updateLineNumbers);
                textarea.addEventListener('scroll', () => {
                    lineNumbers.scrollTop = textarea.scrollTop;
                });
                textarea.addEventListener('keydown', () => setTimeout(updateLineNumbers, 10)); // Pro zachycení změn po keydown
                new ResizeObserver(() => {
                    setTimeout(updateLineNumbers, 50);
                }).observe(textarea);
                // Oprava pro některé prohlížeče: výslovná aktualizace po různých zpožděních
                setTimeout(updateLineNumbers, 50);
                setTimeout(updateLineNumbers, 500);
            }

            // Přidat čísla řádků do editoru textu
            const editorTextarea = document.querySelector('#bottomEditor textarea');
            if (editorTextarea) {
                addLineNumbers(editorTextarea);
            }
            // Zbytek existujícího kódu...
        });

        // Upravit způsob parsování a výpisu do konzole
        function parseAndDisplayWithLineNumbers() {
            const codeContent = editorTextarea.value;
            if (!codeContent || codeContent.trim() === '') {
                console.warn('Žádný kód k parsování');
                return;
            }
            console.clear();
            console.log('%cParsování CNC kódu', 'font-size: 14px; font-weight: bold;');
            import('./js/cnc-line-parser.js').then(module => {
                const parsedProgram = module.parseProgram(codeContent);

                console.log(`%cCelkem ${parsedProgram.length} řádků parsováno`, 'font-weight: bold;');
                const typeCounts = {};
                // Statistiky o typech řádků
                parsedProgram.forEach(line => {
                    if (!typeCounts[line.type]) typeCounts[line.type] = 0;
                    typeCounts[line.type]++;
                });
                console.group('Statistika typů řádků');
                Object.entries(typeCounts).sort((a, b) => b[1] - a[1]).forEach(([type, count]) => {
                    console.log(`${type}: ${count}`);
                });
                console.groupEnd();
            }).catch(error => {
                console.error('Chyba při parsování programu:', error);
            });
        }

        // Aktualizovat event listenery pro tlačítko Parse a kliknutí na programy
        document.addEventListener('DOMContentLoaded', () => {
            // Existující kód...
            // Aktualizace event listeneru pro tlačítko Parse
            const parseButton = document.getElementById('parseButton');
            if (parseButton) {
                parseButton.addEventListener('click', parseAndDisplayWithLineNumbers);
            }
            // ODSTRANĚNO: Duplicitní přepsání funkce addProgramToList
            // Ponechána pouze původní definice funkce
        });

        // Opravená funkce pro očíslování řádků v editoru, která řeší problém s posunutím čísel vůči řádkům textu
        function addLineNumbers(textarea) {
            if (!textarea) return;

            const container = textarea.parentElement;
            // Vytvořit element pro čísla řádků, pokud ještě neexistuje
            let lineNumbers = container.querySelector('.line-numbers');
            if (!lineNumbers) {
                lineNumbers = document.createElement('div');
                lineNumbers.className = 'line-numbers';
                container.insertBefore(lineNumbers, textarea);

                // Přidáváme upravené styly s přesnějším zarovnáním
                const style = document.createElement('style');
                style.textContent = `
                    .editor {
                        position: relative;
                    }
                    .line-numbers {
                        position: absolute;
                        top: 1.5rem;
                        left: 0;
                        width: 40px;
                        height: calc(100% - 1.5rem);
                        padding-top: 0;
                        background-color: #f5f5f5;
                        border-right: 1px solid #ddd;
                        font-family: monospace;
                        font-size: 1rem;
                        color: #777;
                        text-align: right;
                        z-index: 2;
                        user-select: none;
                        pointer-events: none;
                        overflow: hidden;
                        white-space: pre !important;
                        line-height: 1.5;
                    }
                    .editor textarea {
                        padding-left: 45px !important;
                        line-height: 1.5;
                        font-family: monospace !important;
                        font-size: 1rem !important;
                        white-space: pre !important;
                        tab-size: 4 !important;
                        -moz-tab-size: 4 !important;
                        overflow: auto !important;
                    }
                    .line-number {
                        height: 1.5rem;
                        padding-right: 5px;
                        box-sizing: border-box;
                    }
                `;
                document.head.appendChild(style);
            }

            // Upravená funkce pro aktualizaci čísel řádků s přesným zarovnáním
            function updateLineNumbers() {
                const text = textarea.value;
                const lines = text.split('\n');
                lineNumbers.innerHTML = ''; // Vyčistit předchozí obsah
                // Použijeme přístup s vytvářením elementů pro každé číslo řádku
                for (let i = 0; i < lines.length; i++) {
                    const lineNumber = document.createElement('div');
                    lineNumber.className = 'line-number';
                    lineNumber.textContent = (i + 1).toString();
                    lineNumbers.appendChild(lineNumber);
                }
                // Zajištění stejné výšky a synchronizace scrollu
                lineNumbers.style.height = textarea.clientHeight + 'px';
                lineNumbers.scrollTop = textarea.scrollTop;
            }

            // Inicializace a event listenery
            updateLineNumbers();
            textarea.addEventListener('input', updateLineNumbers);
            textarea.addEventListener('scroll', () => {
                lineNumbers.scrollTop = textarea.scrollTop;
            });
            textarea.addEventListener('keydown', () => setTimeout(updateLineNumbers, 10));
            new ResizeObserver(() => {
                setTimeout(updateLineNumbers, 50);
            }).observe(textarea);
            // Oprava pro některé prohlížeče: výslovná aktualizace po různých zpožděních
            setTimeout(updateLineNumbers, 50);
            setTimeout(updateLineNumbers, 500);
            setTimeout(updateLineNumbers, 1000);
        }

        // Kompletně přepracovaná funkce pro čísla řádků pomocí overlay elementu
        function addLineNumbers(textarea) {
            if (!textarea) return;

            const container = textarea.parentElement;
            // Odstranit existující line-numbers, pokud existuje
            const existingLineNumbers = container.querySelector('.line-numbers');
            if (existingLineNumbers) {
                existingLineNumbers.remove();
            }

            // Přidat nové CSS styly přímo do dokumentu
            const styleId = 'line-numbers-style';
            let style = document.getElementById(styleId);
            if (!style) {
                style = document.createElement('style');
                style.id = styleId;
                document.head.appendChild(style);
            }
            style.textContent = `
                .editor {
                    position: relative;
                }
                .editor textarea {
                    padding-left: 45px !important;
                    font-family: monospace !important;
                    font-size: 1rem !important;
                    line-height: 1.5 !important;
                    white-space: pre !important;
                    tab-size: 4 !important;
                    -moz-tab-size: 4 !important;
                    overflow: auto !important;
                }
                .line-numbers {
                    position: absolute;
                    left: 0;
                    top: 0;
                    margin-top: 1.5rem;
                    width: 40px;
                    height: calc(100% - 1.5rem);
                    padding-top: 0;
                    background: #f5f5f5;
                    border-right: 1px solid #ddd;
                    overflow: hidden;
                    display: flex;
                    flex-direction: column;
                    z-index: 2;
                    pointer-events: none;
                    user-select: none;
                }
                .line-numbers > div {
                    font-family: monospace;
                    font-size: 1rem;
                    color: #777;
                    height: 1.5rem;
                    line-height: 1.5;
                    text-align: right;
                    padding-right: 8px;
                    white-space: nowrap;
                }
            `;

            // Vytvořit container pro čísla řádků
            const lineNumbers = document.createElement('div');
            lineNumbers.className = 'line-numbers';
            container.appendChild(lineNumbers);

            // Funkce pro aktualizaci čísel řádků
            function updateLineNumbers() {
                const lines = textarea.value.split('\n');
                lineNumbers.innerHTML = ''; // Vyčistit předchozí obsah
                // Vytvořit elementy pro každé číslo řádku
                for (let i = 0; i < lines.length; i++) {
                    const lineElement = document.createElement('div');
                    lineElement.textContent = (i + 1).toString();
                    lineNumbers.appendChild(lineElement);
                }
                // Zajistit, že container má stejnou výšku jako textarea
                lineNumbers.style.height = `${textarea.clientHeight - textarea.scrollTop}px`;
                // Synchronizace scrollu
                lineNumbers.scrollTop = textarea.scrollTop;
            }

            // Zajistit správnou pozici line-numbers při příliš nízkém textarea
            function adjustPosition() {
                const textareaTop = textarea.getBoundingClientRect().top;
                lineNumbers.style.height = `${textarea.clientHeight}px`;
                lineNumbers.style.top = 0;
            }

            // Přidat event listenery
            textarea.addEventListener('input', updateLineNumbers);
            textarea.addEventListener('scroll', () => {
                lineNumbers.scrollTop = textarea.scrollTop;
            });
            textarea.addEventListener('keydown', () => {
                setTimeout(updateLineNumbers, 10);
            });

            // Používat ResizeObserver pro sledování změn velikosti
            if (window.ResizeObserver) {
                const resizeObserver = new ResizeObserver(() => {
                    adjustPosition();
                    updateLineNumbers();
                });
                resizeObserver.observe(textarea);
            }

            // Inicializace
            adjustPosition();
            updateLineNumbers();
            // Vícenásobně volat aktualizaci pro jistotu
            setTimeout(updateLineNumbers, 50);
            setTimeout(updateLineNumbers, 200);
            setTimeout(updateLineNumbers, 500);
            setTimeout(updateLineNumbers, 1000);

            // Vystavit funkci pro manuální aktualizaci
            textarea.updateLineNumbers = updateLineNumbers;
            return updateLineNumbers;
        }

        // Přepsat handlery kliknutí na editorHandle, aby správně aktualizovaly číslování
        editorHandle.addEventListener('click', (e) => {
            if (isDragging) return;
            e.stopPropagation();
            isMiddleOpen = !isMiddleOpen;
            if (isMiddleOpen) {
                const availableSpace = 100 - MIDDLE_HEIGHT;
                const ratio = topHeight / (topHeight + bottomHeight);
                topHeight = availableSpace * ratio;
                bottomHeight = availableSpace * (1 - ratio);
            } else {
                const ratio = topHeight / (topHeight + bottomHeight);
                topHeight = 99 * ratio;
                bottomHeight = 99 * (1 - ratio);
            }
            updateHeights();

            // Počkat na dokončení animace a změnu velikosti
            setTimeout(() => {
                const editorTextarea = document.querySelector('#bottomEditor textarea');
                if (editorTextarea) {
                    // Znovu aplikovat číslování řádků pro jistotu
                    addLineNumbers(editorTextarea);
                }
            }, 300);
        });

        document.addEventListener('DOMContentLoaded', function () {
            // Najít textarea element v editor kontejneru
            const textarea = document.querySelector('#bottomEditor textarea');
            if (textarea) {
                setupLineNumbers(textarea);
            }

            // Nastavit event listener na menu tlačítko jen jednou
            const editorHandle = document.getElementById('editorHandle');
            if (editorHandle) {
                editorHandle._originalClickHandler = editorHandle.onclick;
                editorHandle.onclick = function (e) {
                    if (editorHandle._originalClickHandler) {
                        editorHandle._originalClickHandler.call(this, e);
                    }
                    // Po dokončení animace obnovit čísla řádků
                    setTimeout(function () {
                        refreshLineNumbers();
                    }, 300);
                };
            }
        });

        // Zcela nová implementace číslování řádků
        function setupLineNumbers(textarea) {
            const container = textarea.parentElement;
            // Odstranit existující číslování řádků
            const existingLineNumbers = container.querySelector('.line-numbers');
            if (existingLineNumbers) {
                existingLineNumbers.remove();
            }

            // Vytvořit nový kontejner pro čísla řádků
            const lineNumbers = document.createElement('div');
            lineNumbers.className = 'line-numbers';
            container.insertBefore(lineNumbers, textarea);

            // Přidat CSS do dokumentu
            const style = document.createElement('style');
            style.textContent = `
                .editor {
                    position: relative;
                }
                .line-numbers {
                    position: absolute;
                    top: 1.5rem;
                    left: 0;
                    width: 40px;
                    height: calc(100% - 1.5rem);
                    background-color: #f5f5f5;
                    border-right: 1px solid #ddd;
                    padding: 0;
                    font-family: monospace;
                    font-size: 1rem;
                    color: #777;
                    text-align: right;
                    user-select: none;
                    pointer-events: none;
                    overflow: hidden;
                    z-index: 2;
                    margin-top: 0;
                }
                .line-numbers div {
                    padding-right: 5px;
                    height: 1.5rem;
                    line-height: 1.5rem;
                    white-space: nowrap;
                }
                .editor textarea {
                    padding-left: 45px !important;
                    line-height: 1.5rem !important;
                    font-family: monospace !important;
                    font-size: 1rem !important;
                    white-space: pre !important;
                    tab-size: 4;
                }
            `;
            document.head.appendChild(style);

            // Funkce pro aktualizaci čísel řádků
            function updateLineNumbers() {
                // Získat text z textarea
                const text = textarea.value;
                const lines = text.split('\n');
                // Vyčistit a naplnit kontejner čísly řádků
                lineNumbers.innerHTML = '';
                for (let i = 0; i < lines.length; i++) {
                    const div = document.createElement('div');
                    div.textContent = (i + 1);
                    lineNumbers.appendChild(div);
                }
                // Nastavit správnou výšku a pozici
                lineNumbers.style.height = textarea.scrollHeight + 'px';
                lineNumbers.scrollTop = textarea.scrollTop;
            }

            // Event listenery pro synchronizaci
            textarea.addEventListener('input', updateLineNumbers);
            textarea.addEventListener('scroll', function () {
                lineNumbers.scrollTop = textarea.scrollTop;
            });

            // Oprava pro různé změny velikosti
            if (window.ResizeObserver) {
                const resizeObserver = new ResizeObserver(function () {
                    updateLineNumbers();
                });
                resizeObserver.observe(container);
                resizeObserver.observe(textarea);
            }

            // Počáteční aktualizace
            updateLineNumbers();
            // Naplánovat více aktualizací pro jistotu
            setTimeout(updateLineNumbers, 100);
            setTimeout(updateLineNumbers, 500);

            // Uložit funkci pro pozdější použití
            window.refreshLineNumbers = updateLineNumbers;
        }

        // Přidat globální funkci pro obnovení čísel řádků
        function refreshLineNumbers() {
            const textarea = document.querySelector('#bottomEditor textarea');
            if (textarea) {
                const lineNumbers = document.querySelector('.line-numbers');
                if (lineNumbers) {
                    lineNumbers.style.height = textarea.scrollHeight + 'px';
                    lineNumbers.scrollTop = textarea.scrollTop;
                    // Během scrollování může dojít k posunu, opravit to
                    const text = textarea.value;
                    const lines = text.split('\n');
                    if (lineNumbers.children.length !== lines.length) {
                        // Pokud se počet řádků změnil, vynutit kompletní obnovu
                        setupLineNumbers(textarea);
                    }
                } else {
                    // Pokud chybí element s čísly řádků, vytvořit ho znovu
                    setupLineNumbers(textarea);
                }
            }
        }

        // Nahradit handler na editorHandle
        editorHandle.addEventListener('click', (e) => {
            if (isDragging) return;
            e.stopPropagation();
            isMiddleOpen = !isMiddleOpen;
            if (isMiddleOpen) {
                const availableSpace = 100 - MIDDLE_HEIGHT;
                const ratio = topHeight / (topHeight + bottomHeight);
                topHeight = availableSpace * ratio;
                bottomHeight = availableSpace * (1 - ratio);
            } else {
                const ratio = topHeight / (topHeight + bottomHeight);
                topHeight = 99 * ratio;
                bottomHeight = 99 * (1 - ratio);
            }
            updateHeights();

            // Počkat na dokončení animace a pak aktualizovat čísla řádků
            setTimeout(refreshLineNumbers, 300);
        });

        // Odstranit ostatní překrývající se funkce addLineNumbers nebo je nahradit voláním refreshLineNumbers()
        // Zde by měly být odstraněny všechny duplicitní definice addLineNumbers

        document.addEventListener('DOMContentLoaded', () => {
            // Předchozí kód zůstává
            loadCNCProgramFromJSON();

            const consoleButton = document.getElementById('consoleButton');
            if (consoleButton) {
                consoleButton.addEventListener('click', toggleMobileConsole);
            }

            setupMobileConsoleOutput();

            // KOMPLETNÍ NÁHRADA VŠECH UDÁLOSTÍ SPOJENÝCH S EDITOREM A TLAČÍTKEM MENU

            // Najít potřebné elementy
            const editorHandle = document.getElementById('editorHandle');
            if (!editorHandle) return;

            // Vytvořit nový element tlačítka Menu bez jakýchkoli existujících handlerů
            const newEditorHandle = document.createElement('div');
            newEditorHandle.id = 'editorHandle';
            newEditorHandle.className = 'editor-label';
            newEditorHandle.textContent = 'Menu';

            // Nahradit starý element novým - úplně vyčistí všechny předchozí event listenery
            if (editorHandle.parentNode) {
                editorHandle.parentNode.replaceChild(newEditorHandle, editorHandle);
            }

            // Deklarace proměnných pro tažení
            let isDragging = false;
            let startY, startTopHeight, startBottomHeight;

            // 1. Přidat event listener pro kliknutí - pouze pro přepínání panelu
            newEditorHandle.addEventListener('click', function (e) {
                // Pokud probíhá tažení, nezpracovávat kliknutí
                if (isDragging) return;

                console.log('Menu tlačítko kliknuto - přepínání panelu');
                e.preventDefault();
                e.stopPropagation();

                // Přepnout stav otevření
                isMiddleOpen = !isMiddleOpen;

                // Nastavit výšky podle stavu
                if (isMiddleOpen) {
                    console.log('Otevírám panel editoru');
                    const availableSpace = 100 - MIDDLE_HEIGHT;
                    topHeight = availableSpace * 0.7; // 70% horní panel
                    bottomHeight = availableSpace * 0.3; // 30% dolní panel
                } else {
                    console.log('Zavírám panel editoru');
                    topHeight = 99;
                    bottomHeight = 1;
                }

                // Aktualizovat výšky elementů
                topEditor.style.height = `${topHeight}vh`;
                middleWindow.style.height = `${isMiddleOpen ? MIDDLE_HEIGHT : 1}vh`;
                bottomEditor.style.height = `${bottomHeight}vh`;
                middleContent.classList.toggle('hidden', !isMiddleOpen);

                // Aktualizovat číslování řádků po dokončení animace
                setTimeout(function () {
                    setupSimpleLineNumbers();
                    console.log('Číslování řádků aktualizováno po přepnutí');
                }, 300);
            });

            // 2. Přidat event listener pro zahájení tažení
            newEditorHandle.addEventListener('mousedown', function (e) {
                // Ignorovat ostatní tlačítka myši kromě hlavního (levého)
                if (e.button !== 0) return;

                console.log('Menu mousedown - zahajuji tažení');
                isDragging = true;
                startY = e.clientY;
                startTopHeight = topHeight;
                startBottomHeight = bottomHeight;

                // Změnit kurzor
                document.body.style.cursor = 'row-resize';

                // Zabránit výchozímu chování
                e.preventDefault();
                e.stopPropagation();
            });

            // 3. Přidat event listener pro pohyb myši - reagovat pouze pokud je aktivní tažení
            document.addEventListener('mousemove', function (e) {
                if (!isDragging) return;

                // Vypočítat změnu výšky
                const deltaY = e.clientY - startY;
                const deltaPercent = (deltaY / window.innerHeight) * 100;

                // Vypočítat nové výšky panelů
                const availableSpace = 100 - (isMiddleOpen ? MIDDLE_HEIGHT : 1);
                const newTopHeight = Math.max(20, Math.min(availableSpace - 20, startTopHeight + deltaPercent));
                const newBottomHeight = availableSpace - newTopHeight;

                // Nastavit nové výšky pouze pokud jsou v platném rozsahu
                if (newBottomHeight >= 20) {
                    topHeight = newTopHeight;
                    bottomHeight = newBottomHeight;
                    updateHeights();
                    console.log(`Tažení: topHeight=${topHeight.toFixed(1)}, bottomHeight=${bottomHeight.toFixed(1)}`);
                }
            });

            // 4. Přidat event listener pro ukončení tažení
            document.addEventListener('mouseup', function () {
                if (!isDragging) return;

                console.log('Ukončuji tažení');
                isDragging = false;
                document.body.style.cursor = '';

                // Aktualizovat číslování řádků
                setTimeout(function () {
                    setupSimpleLineNumbers();
                }, 100);
            });

            // 5. Přidat podporu pro dotyková zařízení
            newEditorHandle.addEventListener('touchstart', function (e) {
                console.log('Touch start na Menu');
                isDragging = true;
                startY = e.touches[0].clientY;
                startTopHeight = topHeight;
                startBottomHeight = bottomHeight;

                e.preventDefault(); // Důležité pro zabránění scrollování stránky
            }, { passive: false });

            document.addEventListener('touchmove', function (e) {
                if (!isDragging) return;

                const touch = e.touches[0];
                const deltaY = touch.clientY - startY;
                const deltaPercent = (deltaY / window.innerHeight) * 100;

                const availableSpace = 100 - (isMiddleOpen ? MIDDLE_HEIGHT : 1);
                const newTopHeight = Math.max(20, Math.min(availableSpace - 20, startTopHeight + deltaPercent));
                const newBottomHeight = availableSpace - newTopHeight;

                if (newBottomHeight >= 20) {
                    topHeight = newTopHeight;
                    bottomHeight = newBottomHeight;
                    updateHeights();
                }

                e.preventDefault(); // Zabránit scrollování stránky
            }, { passive: false });

            document.addEventListener('touchend', function () {
                if (!isDragging) return;

                console.log('Touch end - ukončuji tažení');
                isDragging = false;

                // Aktualizovat číslování řádků
                setTimeout(function () {
                    setupSimpleLineNumbers();
                }, 100);
            });

            console.log('Nové event handlery pro Menu tlačítko úspěšně nastaveny');
        });

        // Přidat novou jednodušší implementaci číslování řádků, která nepřekáží
        function setupSimpleLineNumbers() {
            const textarea = document.querySelector('#bottomEditor textarea');
            if (!textarea) {
                console.warn('Textarea nenalezen');
                return;
            }

            console.log('Vytvářím nové jednoduché číslování řádků');

            // Odstranit případné existující číslování
            const container = textarea.parentElement;
            const oldLineNumbers = container.querySelector('.line-numbers');
            if (oldLineNumbers) {
                oldLineNumbers.remove();
            }

            // Vytvořit nový element pro čísla řádků
            const lineNumbers = document.createElement('div');
            lineNumbers.className = 'line-numbers';
            container.insertBefore(lineNumbers, textarea);

            // Přidáme základní styly v tagu style na stránce
            let styleEl = document.getElementById('simple-line-numbers-style');
            if (!styleEl) {
                styleEl = document.createElement('style');
                styleEl.id = 'simple-line-numbers-style';
                styleEl.textContent = `
                    .line-numbers {
                        position: absolute;
                        top: 1.5rem;
                        left: 0;
                        width: 40px;
                        height: calc(100% - 1.5rem);
                        background-color: #f5f5f5;
                        border-right: 1px solid #ddd;
                        font-family: monospace;
                        font-size: 1rem;
                        color: #777;
                        text-align: right;
                        padding: 0;
                        overflow: hidden;
                        user-select: none;
                        pointer-events: none;
                        z-index: 2;
                    }
                    .editor textarea {
                        padding-left: 45px !important;
                        font-family: monospace;
                        white-space: pre !important;
                        tab-size: 4;
                    }
                    .line-number {
                        padding-right: 5px;
                        height: 1.5rem;
                        line-height: 1.5rem;
                    }
                `;
                document.head.appendChild(styleEl);
            }

            // Funkce pro aktualizaci čísel řádků
            function updateLineNumbers() {
                const lines = textarea.value.split('\n');
                lineNumbers.innerHTML = '';

                for (let i = 0; i < lines.length; i++) {
                    const div = document.createElement('div');
                    div.className = 'line-number';
                    div.textContent = (i + 1);
                    lineNumbers.appendChild(div);
                }

                lineNumbers.style.height = textarea.scrollHeight + 'px';
                lineNumbers.scrollTop = textarea.scrollTop;
            }

            // Přidat event listenery
            textarea.addEventListener('input', updateLineNumbers);
            textarea.addEventListener('scroll', function () {
                lineNumbers.scrollTop = textarea.scrollTop;
            });

            // Inicializace a následné aktualizace
            updateLineNumbers();
            setTimeout(updateLineNumbers, 100);

            // Exportovat funkci pro pozdější použití
            window.updateLineNumbers = updateLineNumbers;

            console.log('Číslování řádků úspěšně nastaveno');
            return updateLineNumbers;
        }

        // Přidat event listener pro tlačítko konzole
        const consoleButton = document.getElementById('consoleButton');
        if (consoleButton) {
            consoleButton.addEventListener('click', toggleMobileConsole);
        }

        // Nahradit původní console.log pro zachycení výstupu
        setupMobileConsoleOutput();

        // Funkce pro přepínání mobilní konzole
        function toggleMobileConsole() {
            const mobileConsole = document.getElementById('mobileConsole');
            if (mobileConsole) {
                mobileConsole.classList.toggle('open');
            }
        }

        // Funkce pro nastavení přesměrování konzolového výstupu
        function setupMobileConsoleOutput() {
            const consoleContent = document.getElementById('mobileConsoleContent');
            if (!consoleContent) return;

            // Uložit originální metody konzole
            const originalLog = console.log;
            const originalError = console.error;
            const originalWarn = console.warn;
            const originalInfo = console.info;
            const originalClear = console.clear;

            // Funkce pro přidání záznamu do mobilní konzole
            function addLogEntry(message, type = 'log') {
                const entry = document.createElement('div');
                entry.className = `log-entry ${type}`;
                let messageText;
                // Převést různé typy vstupů na string
                if (typeof message === 'object') {
                    try {
                        messageText = JSON.stringify(message, null, 2);
                    } catch (e) {
                        messageText = String(message);
                    }
                } else {
                    messageText = String(message);
                }
                entry.textContent = messageText;
                consoleContent.appendChild(entry);
                consoleContent.scrollTop = consoleContent.scrollHeight;
            }

            // Přepsat metody konzole
            console.log = function (...args) {
                originalLog.apply(console, args);
                args.forEach(msg => addLogEntry(msg, 'log'));
            };
            console.error = function (...args) {
                originalError.apply(console, args);
                args.forEach(msg => addLogEntry(msg, 'error'));
            };
            console.warn = function (...args) {
                originalWarn.apply(console, args);
                args.forEach(msg => addLogEntry(msg, 'warn'));
            };
            console.info = function (...args) {
                originalInfo.apply(console, args);
                args.forEach(msg => addLogEntry(msg, 'info'));
            };
            console.clear = function () {
                originalClear.apply(console);
                consoleContent.innerHTML = '';
                addLogEntry('Console was cleared', 'info');
            };
        }

        // Na začátku skriptové části přidám inicializaci pro input elementy a event listenery pro tlačítka načítání
        document.addEventListener('DOMContentLoaded', function() {
            // Oprava funkcionality tlačítek pro načítání souboru
            const loadCncButton = document.getElementById('loadCncButton');
            const fileInput = document.getElementById('fileInput');

            if (loadCncButton && fileInput) {
                // Přímé propojení tlačítka s file inputem
                loadCncButton.addEventListener('click', function() {
                    fileInput.click();
                });

                // Přidat event listener pro zpracování vybraných souborů
                fileInput.addEventListener('change', function(e) {
                    if (e.target.files.length > 0) {
                        handleFileSelection(e.target.files);
                    }
                });
            }

            // Přidám handler pro zpracování vybraných souborů
            function handleFileSelection(files) {
                const programList = document.getElementById('programList');

                // Vyčistit seznam, pokud bylo vybráno více souborů najednou
                if (files.length > 1) {
                    programList.innerHTML = '';
                }

                // Zpracování každého vybraného souboru
                Array.from(files).forEach(file => {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        const fileContent = event.target.result;

                        // Vytvořit nový objekt program
                        const program = {
                            name: file.name,
                            description: `Program ${file.name}`,
                            type: file.name.toLowerCase().endsWith('.mpf') ? 'MPF' : 'SPF',
                            code: fileContent.split('\n')
                        };

                        // Přidat program do seznamu
                        addProgramToList(program, programList, true);

                        console.log(`Načten soubor: ${file.name}`);
                    };
                    reader.readAsText(file);
                });

                // Otevřít panel s programy, pokud ještě není otevřený
                const topPanel = document.getElementById('topPanel');
                if (!topPanel.classList.contains('open')) {
                    topPanel.classList.add('open');
                    adjustHeightsForTopPanel(true);
                }
            }

            // Existující kód pro načítání JSON
            const loadJsonButton = document.getElementById('loadJsonButton');
            if (loadJsonButton) {
                loadJsonButton.addEventListener('click', function() {
                    const jsonFileInput = document.createElement('input');
                    jsonFileInput.type = 'file';
                    jsonFileInput.accept = '.json';
                    jsonFileInput.style.display = 'none';
                    jsonFileInput.addEventListener('change', (e) => {
                        if (e.target.files.length > 0) {
                            const file = e.target.files[0];
                            const reader = new FileReader();
                            reader.onload = (event) => {
                                loadProgramsFromJson(event.target.result);
                            };
                            reader.readAsText(file);
                        }
                    });
                    document.body.appendChild(jsonFileInput);
                    jsonFileInput.click();
                    document.body.removeChild(jsonFileInput);
                });
            }

            // Existující kód pro ukládání CNC programu
            const saveButton = document.getElementById('saveButton');
            if (saveButton) {
                saveButton.addEventListener('click', saveCurrentProgram);
            }

            // Existující kód pro ukládání programů jako JSON
            const saveJsonButton = document.getElementById('saveJsonButton');
            if (saveJsonButton) {
                saveJsonButton.addEventListener('click', saveProgramsToJson);
            }

            // Přidání dvou nových tlačítek do prostřední lišty
            const middleContent = document.querySelector('.middle-content');
            const simulatorButton = document.getElementById('simulatorButton');

            if (middleContent && simulatorButton) {
                // Zkontrolujeme, zda již existují tlačítka parametersButton a parseModalButton
                const existingParametersButton = document.getElementById('parametersButton');
                const existingParseModalButton = document.getElementById('parseModalButton');

                // Přidáme tlačítka jen pokud ještě neexistují
                if (!existingParametersButton) {
                    // 1. Tlačítko pro parametry
                    const parametersButton = document.createElement('button');
                    parametersButton.id = 'parametersButton';
                    parametersButton.className = 'square-button';
                    parametersButton.title = 'Zobrazit parametry';
                    parametersButton.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20h9"></path><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path></svg>';
                    middleContent.insertBefore(parametersButton, simulatorButton);

                    // Přidání event listeneru
                    parametersButton.addEventListener('click', function() {
                        showParametersModal();
                    });
                }

                if (!existingParseModalButton) {
                    // 2. Tlačítko pro modální okno s parsovanými řádky
                    const parseModalButton = document.createElement('button');
                    parseModalButton.id = 'parseModalButton';
                    parseModalButton.className = 'square-button';
                    parseModalButton.title = 'Parsované řádky';
                    parseModalButton.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"></path><rect x="8" y="8" width="8" height="8" rx="1"></rect></svg>';
                    middleContent.insertBefore(parseModalButton, simulatorButton);

                    // Přidání event listeneru
                    parseModalButton.addEventListener('click', function() {
                        showParsedLinesModal();
                    });
                }
            }
        });

        // Přidání nových funkcí pro modální okna
        // Modální okno pro parametry
        function showParametersModal() {
            // Odstranit existující modální okno, pokud existuje
            const existingModal = document.getElementById('parametersModal');
            if (existingModal) existingModal.remove();

            // Vytvořit nové modální okno
            const modal = document.createElement('div');
            modal.id = 'parametersModal';
            modal.className = 'modal-window';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>Parametry CNC programu</h3>
                        <button class="modal-close">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div id="parametersContent">
                            <p>Načtěte CNC program pro zobrazení parametrů.</p>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            // Přidat event listener pro zavření modálního okna
            modal.querySelector('.modal-close').addEventListener('click', function() {
                modal.remove();
            });

            // Pokud máme aktivní program, analyzujeme jeho parametry
            if (activeProgram) {
                const code = activeProgram.dataset.code;
                analyzeProgramParameters(code);
            }

            // Přidat zavírání kliknutím mimo modální okno
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });

            // Zobrazit modální okno s animací
            setTimeout(() => modal.classList.add('open'), 10);
        }

        // Modální okno pro parsované řádky
        function showParsedLinesModal() {
            // Odstranit existující modální okno, pokud existuje
            const existingModal = document.getElementById('parsedLinesModal');
            if (existingModal) existingModal.remove();

            // Vytvořit nové modální okno
            const modal = document.createElement('div');
            modal.id = 'parsedLinesModal';
            modal.className = 'modal-window';
            modal.innerHTML = `
                <div class="modal-content wide">
                    <div class="modal-header">
                        <h3>Parsované řádky CNC programu</h3>
                        <button class="modal-close">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div id="parsedLinesContent">
                            <p>Načtěte CNC program pro zobrazení parsovaných řádků.</p>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            // Přidat event listener pro zavření modálního okna
            modal.querySelector('.modal-close').addEventListener('click', function() {
                modal.remove();
            });

            // Pokud máme aktivní program, parsujeme jeho řádky
            if (activeProgram) {
                const code = activeProgram.dataset.code;
                showParsedLines(code);
            }

            // Přidat zavírání kliknutím mimo modální okno
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });

            // Zobrazit modální okno s animací
            setTimeout(() => modal.classList.add('open'), 10);
        }

        // Funkce pro analýzu parametrů programu
        function analyzeProgramParameters(code) {
            const content = document.getElementById('parametersContent');
            if (!content) return;

            content.innerHTML = '<p>Probíhá analýza parametrů...</p>';

            import('./js/cnc-line-parser.js').then(module => {
                const parsedProgram = module.parseProgram(code);

                // Extrakce relevantních parametrů
                const parameters = {
                    gCodes: new Set(),
                    mCodes: new Set(),
                    tools: new Set(),
                    coordinates: {
                        minX: Infinity,
                        maxX: -Infinity,
                        minY: Infinity,
                        maxY: -Infinity,
                        minZ: Infinity,
                        maxZ: -Infinity
                    },
                    feedRates: new Set(),
                    spindleSpeeds: new Set()
                };

                parsedProgram.forEach(line => {
                    // G-kódy
                    if (line.gCodes) {
                        line.gCodes.forEach(code => parameters.gCodes.add(code));
                    }

                    // M-kódy
                    if (line.mCodes) {
                        line.mCodes.forEach(code => parameters.mCodes.add(code));
                    }

                    // Nástroje
                    if (line.tool) {
                        parameters.tools.add(line.tool);
                    }

                    // Souřadnice
                    if (line.coordinates) {
                        if (line.coordinates.X !== undefined) {
                            parameters.coordinates.minX = Math.min(parameters.coordinates.minX, line.coordinates.X);
                            parameters.coordinates.maxX = Math.max(parameters.coordinates.maxX, line.coordinates.X);
                        }
                        if (line.coordinates.Y !== undefined) {
                            parameters.coordinates.minY = Math.min(parameters.coordinates.minY, line.coordinates.Y);
                            parameters.coordinates.maxY = Math.max(parameters.coordinates.maxY, line.coordinates.Y);
                        }
                        if (line.coordinates.Z !== undefined) {
                            parameters.coordinates.minZ = Math.min(parameters.coordinates.minZ, line.coordinates.Z);
                            parameters.coordinates.maxZ = Math.max(parameters.coordinates.maxZ, line.coordinates.Z);
                        }
                    }

                    // Posuvy
                    if (line.feedRate) {
                        parameters.feedRates.add(line.feedRate);
                    }

                    // Otáčky vřetena
                    if (line.spindleSpeed) {
                        parameters.spindleSpeeds.add(line.spindleSpeed);
                    }
                });

                // Formátování výstupu
                let html = '<div class="parameters-grid">';

                // G-kódy
                html += '<div class="parameter-section">';
                html += '<h4>G-kódy</h4>';
                html += '<div class="parameter-list">';
                Array.from(parameters.gCodes).sort((a, b) => a - b).forEach(code => {
                    html += `<span class="parameter-tag">G${code}</span>`;
                });
                html += '</div></div>';

                // M-kódy
                html += '<div class="parameter-section">';
                html += '<h4>M-kódy</h4>';
                html += '<div class="parameter-list">';
                Array.from(parameters.mCodes).sort((a, b) => a - b).forEach(code => {
                    html += `<span class="parameter-tag">M${code}</span>`;
                });
                html += '</div></div>';

                // Nástroje
                html += '<div class="parameter-section">';
                html += '<h4>Nástroje</h4>';
                html += '<div class="parameter-list">';
                if (parameters.tools.size > 0) {
                    Array.from(parameters.tools).sort((a, b) => a - b).forEach(tool => {
                        html += `<span class="parameter-tag">T${tool}</span>`;
                    });
                } else {
                    html += '<span class="parameter-none">Žádné nástroje</span>';
                }
                html += '</div></div>';

                // Rozsahy souřadnic
                html += '<div class="parameter-section wide">';
                html += '<h4>Rozsahy souřadnic</h4>';
                html += '<table class="parameter-table">';
                html += '<tr><th></th><th>Min</th><th>Max</th><th>Rozsah</th></tr>';

                // X souřadnice
                if (parameters.coordinates.minX !== Infinity && parameters.coordinates.maxX !== -Infinity) {
                    const rangeX = parameters.coordinates.maxX - parameters.coordinates.minX;
                    html += `<tr>
                        <td>X:</td>
                        <td>${parameters.coordinates.minX.toFixed(3)}</td>
                        <td>${parameters.coordinates.maxX.toFixed(3)}</td>
                        <td>${rangeX.toFixed(3)}</td>
                    </tr>`;
                }

                // Y souřadnice
                if (parameters.coordinates.minY !== Infinity && parameters.coordinates.maxY !== -Infinity) {
                    const rangeY = parameters.coordinates.maxY - parameters.coordinates.minY;
                    html += `<tr>
                        <td>Y:</td>
                        <td>${parameters.coordinates.minY.toFixed(3)}</td>
                        <td>${parameters.coordinates.maxY.toFixed(3)}</td>
                        <td>${rangeY.toFixed(3)}</td>
                    </tr>`;
                }

                // Z souřadnice
                if (parameters.coordinates.minZ !== Infinity && parameters.coordinates.maxZ !== -Infinity) {
                    const rangeZ = parameters.coordinates.maxZ - parameters.coordinates.minZ;
                    html += `<tr>
                        <td>Z:</td>
                        <td>${parameters.coordinates.minZ.toFixed(3)}</td>
                        <td>${parameters.coordinates.maxZ.toFixed(3)}</td>
                        <td>${rangeZ.toFixed(3)}</td>
                    </tr>`;
                }

                html += '</table></div>';

                // Statistika
                html += '<div class="parameter-section wide">';
                html += '<h4>Statistika programu</h4>';
                html += `<p>Celkem řádků: ${parsedProgram.length}</p>`;
                html += `<p>G-kódy: ${parameters.gCodes.size}</p>`;
                html += `<p>M-kódy: ${parameters.mCodes.size}</p>`;
                html += `<p>Nástroje: ${parameters.tools.size}</p>`;

                // Typy řádků
                const lineTypes = {};
                parsedProgram.forEach(line => {
                    if (!lineTypes[line.type]) lineTypes[line.type] = 0;
                    lineTypes[line.type]++;
                });

                html += '<table class="parameter-table">';
                html += '<tr><th>Typ řádku</th><th>Počet</th></tr>';
                Object.entries(lineTypes).sort((a, b) => b[1] - a[1]).forEach(([type, count]) => {
                    html += `<tr><td>${type}</td><td>${count}</td></tr>`;
                });
                html += '</table>';

                html += '</div>';

                html += '</div>'; // Uzavření parameter-grid

                content.innerHTML = html;
            }).catch(error => {
                content.innerHTML = `<p class="error">Chyba při parsování programu: ${error.message}</p>`;
                console.error('Chyba při analýze parametrů:', error);
            });
        }

        // Funkce pro zobrazení parsovaných řádků
        function showParsedLines(code) {
            const content = document.getElementById('parsedLinesContent');
            if (!content) return;

            content.innerHTML = '<p>Probíhá parsování řádků...</p>';

            import('./js/cnc-line-parser.js').then(module => {
                const parsedProgram = module.parseProgram(code);

                // Vytvoření tabulky parsovaných řádků
                let html = '<table class="parsed-lines-table">';
                html += '<tr><th>Řádek</th><th>Kód</th><th>Typ</th><th>G-kódy</th><th>M-kódy</th><th>Souřadnice</th><th>Komentář</th></tr>';

                parsedProgram.forEach(line => {
                    const lineNumber = line.lineNumber;
                    const originalLine = line.originalLine || '';
                    const type = line.type || 'neuvedeno';

                    // G-kódy
                    let gCodes = '';
                    if (line.gCodes && line.gCodes.length > 0) {
                        gCodes = line.gCodes.map(g => `G${g}`).join(', ');
                    }

                    // M-kódy
                    let mCodes = '';
                    if (line.mCodes && line.mCodes.length > 0) {
                        mCodes = line.mCodes.map(m => `M${m}`).join(', ');
                    }

                    // Souřadnice
                    let coords = '';
                    if (line.coordinates) {
                        coords = Object.entries(line.coordinates)
                            .map(([key, value]) => `${key}${value}`)
                            .join(' ');
                    }

                    // Komentář
                    const comment = line.comment || '';

                    // Přidání řádku do tabulky s barevným zvýrazněním podle typu
                    html += `<tr class="line-type-${type}">`;
                    html += `<td>${lineNumber}</td>`;
                    html += `<td><code>${escapeHtml(originalLine)}</code></td>`;
                    html += `<td>${type}</td>`;
                    html += `<td>${gCodes}</td>`;
                    html += `<td>${mCodes}</td>`;
                    html += `<td>${coords}</td>`;
                    html += `<td>${comment}</td>`;
                    html += `</tr>`;
                });

                html += '</table>';

                content.innerHTML = html;
            }).catch(error => {
                content.innerHTML = `<p class="error">Chyba při parsování programu: ${error.message}</p>`;
                console.error('Chyba při parsování řádků:', error);
            });
        }

        // Pomocná funkce pro escapování HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Přidání stylů pro modální okna do head dokumentu
        const modalStyles = document.createElement('style');
        modalStyles.textContent = `
            .modal-window {
                display: flex;
                justify-content: center;
                align-items: center;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0, 0, 0, 0.5);
                z-index: 1500;
                opacity: 0;
                visibility: hidden;
                transition: opacity 0.3s, visibility 0.3s;
            }

            .modal-window.open {
                opacity: 1;
                visibility: visible;
            }

            .modal-content {
                background-color: white;
                width: 80%;
                max-width: 800px;
                max-height: 90vh;
                border-radius: 8px;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                display: flex;
                flex-direction: column;
                overflow: hidden;
            }

            .modal-content.wide {
                max-width: 1200px;
            }

            .modal-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 15px 20px;
                border-bottom: 1px solid #e5e7eb;
            }

            .modal-header h3 {
                margin: 0;
                font-size: 1.25rem;
                color: #374151;
            }

            .modal-close {
                background: none;
                border: none;
                font-size: 24px;
                cursor: pointer;
                color: #9ca3af;
            }

            .modal-close:hover {
                color: #4b5563;
            }

            .modal-body {
                padding: 20px;
                overflow-y: auto;
                max-height: calc(90vh - 60px);
            }

            .parameter-grid {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
                gap: 20px;
            }

            .parameter-section {
                background-color: #f9fafb;
                border: 1px solid #e5e7eb;
                border-radius: 6px;
                padding: 15px;
                margin-bottom: 10px;
            }

            .parameter-section.wide {
                grid-column: 1 / -1;
            }

            .parameter-section h4 {
                margin-top: 0;
                margin-bottom: 10px;
                color: #4b5563;
                border-bottom: 1px solid #e5e7eb;
                padding-bottom: 8px;
            }

            .parameter-list {
                display: flex;
                flex-wrap: wrap;
                gap: 8px;
            }

            .parameter-tag {
                background-color: #e5e7eb;
                color: #4b5563;
                padding: 4px 8px;
                border-radius: 4px;
                font-family: monospace;
                font-size: 0.9rem;
            }

            .parameter-none {
                color: #9ca3af;
                font-style: italic;
            }

            .parameter-table {
                width: 100%;
                border-collapse: collapse;
            }

            .parameter-table th, .parameter-table td {
                padding: 8px;
                text-align: left;
                border-bottom: 1px solid #e5e7eb;
            }

            .parameter-table th {
                background-color: #f9fafb;
                font-weight: 600;
                color: #4b5563;
            }

            .parsed-lines-table {
                width: 100%;
                border-collapse: collapse;
                font-size: 0.9rem;
            }

            .parsed-lines-table th, .parsed-lines-table td {
                padding: 8px;
                text-align: left;
                border-bottom: 1px solid #e5e7eb;
                border-right: 1px solid #e5e7eb;
            }

            .parsed-lines-table th {
                background-color: #f9fafb;
                font-weight: 600;
                color: #4b5563;
                position: sticky;
                top: 0;
                z-index: 10;
            }

            .parsed-lines-table td code {
                font-family: monospace;
                white-space: nowrap;
            }

            /* Barevné zvýraznění řádků podle typu */
            .line-type-rapid_move {
                background-color: #fee2e2;
            }
            .line-type-linear_move {
                background-color: #e0f2fe;
            }
            .line-type-arc_cw, .line-type-arc_ccw {
                background-color: #d1fae5;
            }
            .line-type-comment {
                background-color: #f3f4f6;
                color: #6b7280;
            }
            .line-type-tool_selection, .line-type-tool_change {
                background-color: #fef3c7;
            }
            .line-type-spindle_control {
                background-color: #dbeafe;
            }
            .line-type-coolant_control {
                background-color: #c7d2fe;
            }

            @media (max-width: 768px) {
                .modal-content {
                    width: 95%;
                    max-height: 85vh;
                }

                .parameter-grid {
                    grid-template-columns: 1fr;
                }

                .parameter-table th, .parameter-table td,
                .parsed-lines-table th, .parsed-lines-table td {
                    padding: 6px;
                    font-size: 0.85rem;
                }

                .parsed-lines-table {
                    display: block;
                    overflow-x: auto;
                    white-space: nowrap;
                }
            }
        `;

        document.head.appendChild(modalStyles);
    </script>
    <script>
        // Na začátku skriptové části přidám inicializaci pro event listenery tlačítek v levém panelu
        document.addEventListener('DOMContentLoaded', function() {
            // Přidání event listenerů pro tlačítka v levém panelu
            const loadCncButtonPanel = document.getElementById('loadCncButtonPanel');
            const saveButtonPanel = document.getElementById('saveButtonPanel');
            const loadJsonButtonPanel = document.getElementById('loadJsonButtonPanel');
            const saveJsonButtonPanel = document.getElementById('saveJsonButtonPanel');
            const fileInput = document.getElementById('fileInput');

            // Event listenery pro tlačítka v levém panelu
            if (loadCncButtonPanel && fileInput) {
                loadCncButtonPanel.addEventListener('click', function() {
                    fileInput.click();
                });
            }

            if (saveButtonPanel) {
                saveButtonPanel.addEventListener('click', function() {
                    saveCurrentProgram();
                    toggleLeftPanel(); // Zavřít panel po uložení
                });
            }

            if (loadJsonButtonPanel) {
                loadJsonButtonPanel.addEventListener('click', function() {
                    const jsonFileInput = document.createElement('input');
                    jsonFileInput.type = 'file';
                    jsonFileInput.accept = '.json';
                    jsonFileInput.style.display = 'none';
                    jsonFileInput.addEventListener('change', function(e) {
                        if (e.target.files.length > 0) {
                            const file = e.target.files[0];
                            const reader = new FileReader();
                            reader.onload = function(event) {
                                loadProgramsFromJson(event.target.result);
                                toggleLeftPanel(); // Zavřít panel po načtení
                            };
                            reader.readAsText(file);
                        }
                    });
                    document.body.appendChild(jsonFileInput);
                    jsonFileInput.click();
                    document.body.removeChild(jsonFileInput);
                });
            }

            if (saveJsonButtonPanel) {
                saveJsonButtonPanel.addEventListener('click', function() {
                    saveProgramsToJson();
                    toggleLeftPanel(); // Zavřít panel po uložení
                });
            }

            // Přidání funkce pro aktualizaci informací o aktivním programu
            window.updateActiveProgramInfo = function(program) {
                const activeProgramInfo = document.getElementById('activeProgram');
                if (!activeProgramInfo) return;

                if (!program) {
                    activeProgramInfo.innerHTML = '<p class="no-program">Žádný aktivní program</p>';
                    return;
                }

                // Zjistit počet řádků kódu
                let codeLines = 0;
                if (program.code) {
                    if (Array.isArray(program.code)) {
                        codeLines = program.code.length;
                    } else if (typeof program.code === 'string') {
                        codeLines = program.code.split('\n').length;
                    }
                }

                let html = `
                    <div class="program-name">${program.name || 'Nepojmenovaný program'}</div>
                    <div class="program-meta">
                        <div>Typ: ${program.type || 'Neurčeno'}</div>
                        <div>Řádků: ${codeLines}</div>
                    </div>
                `;

                activeProgramInfo.innerHTML = html;
            };

            // Přidání event listeneru pro fileInput, pokud ještě není
            if (fileInput) {
                fileInput.addEventListener('change', function(e) {
                    if (e.target.files.length > 0) {
                        handleFileSelection(e.target.files);
                    }
                });
            }

            // Upravíme původní funkci handleFileSelection pro aktualizaci informací v levém panelu
            window.handleFileSelection = function(files) {
                if (!files || files.length === 0) return;

                const programList = document.getElementById('programList');

                // Vyčistit seznam, pokud bylo vybráno více souborů najednou
                if (files.length > 1) {
                    programList.innerHTML = '';
                }

                // Zpracování každého vybraného souboru
                Array.from(files).forEach(file => {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        const fileContent = event.target.result;

                        // Vytvořit nový objekt program
                        const program = {
                            name: file.name,
                            description: `Program ${file.name}`,
                            type: file.name.toLowerCase().endsWith('.mpf') ? 'MPF' : 'SPF',
                            code: fileContent.split('\n')
                        };

                        // Přidat program do seznamu
                        addProgramToList(program, programList, true);

                        // Aktualizovat informace v levém panelu
                        updateActiveProgramInfo(program);

                        console.log(`Načten soubor: ${file.name}`);

                        // Zavřít levý panel po načtení
                        toggleLeftPanel();
                    };
                    reader.readAsText(file);
                });

                // Otevřít panel s programy, pokud ještě není otevřený
                const topPanel = document.getElementById('topPanel');
                if (!topPanel.classList.contains('open')) {
                    topPanel.classList.add('open');
                    adjustHeightsForTopPanel(true);
                }
            };

            // Modifikace funkce addProgramToList pro aktualizaci panelu aktivního programu
            const originalAddProgramToList = window.addProgramToList || function() {};

            window.addProgramToList = function(program, programList, activate = false) {
                const programItem = document.createElement('div');
                programItem.className = 'program-item';
                let displayName = program.name;
                // Odstranit příponu .spf z názvu, pokud existuje
                if (program.type === 'SPF' && displayName.toLowerCase().endsWith('.spf')) {
                    displayName = displayName.substring(0, displayName.length - 4);
                }
                programItem.textContent = displayName;
                programItem.dataset.originalName = program.name; // Uchovat původní název pro odkazy
                programItem.dataset.code = program.code.join('\n');

                // Načíst kód programu do editoru
                programItem.onclick = () => {
                    editorTextarea.value = programItem.dataset.code;
                    // Zvýraznění aktivního programu
                    if (activeProgram) {
                        activeProgram.classList.remove('active');
                    }
                    programItem.classList.add('active');
                    activeProgram = programItem;

                    // Aktualizovat informace v levém panelu
                    updateActiveProgramInfo({
                        name: displayName,
                        type: program.type,
                        code: programItem.dataset.code
                    });

                    // Panel se již automaticky nezavírá, odstraněna podmínka isPanelFrozen
                    console.clear();
                    console.log(`Parsování programu: ${program.name}`);
                    import('./js/cnc-line-parser.js').then(module => {
                        const parsedProgram = module.parseProgram(programItem.dataset.code);

                        console.log(`Celkem ${parsedProgram.length} řádků parsováno`);
                        const typeCounts = {};
                        // Statistiky o typech řádků
                        parsedProgram.forEach(line => {
                            if (!typeCounts[line.type]) typeCounts[line.type] = 0;
                            typeCounts[line.type]++;
                        });
                        console.group('Statistika typů řádků');
                        Object.entries(typeCounts).sort((a, b) => b[1] - a[1]).forEach(([type, count]) => {
                            console.log(`${type}: ${count}`);
                        });
                        console.groupEnd();
                    }).catch(error => {
                        console.error('Chyba při parsování programu:', error);
                    });
                };

                programList.appendChild(programItem);

                // Pokud je označen jako aktivní, nastavit jako aktivní
                if (activate) {
                    editorTextarea.value = programItem.dataset.code;
                    programItem.classList.add('active');
                    activeProgram = programItem;

                    // Aktualizovat informace v levém panelu
                    updateActiveProgramInfo({
                        name: displayName,
                        type: program.type,
                        code: programItem.dataset.code
                    });
                }

                return programItem;
            };
        });

        // Upravím sekci DOMContentLoaded, kde jsou přidávána a inicializována tlačítka
        document.addEventListener('DOMContentLoaded', function() {
            // ...existing code...

            // Přidání funkcí k existujícím tlačítkům v prostřední liště
            const parametersButton = document.getElementById('parametersButton');
            const parseModalButton = document.getElementById('parseModalButton');

            if (parametersButton) {
                // Přidání správné funkce pro tlačítko parametrů
                parametersButton.addEventListener('click', function() {
                    showParametersModal();
                });
            }

            if (parseModalButton) {
                // Přidání správné funkce pro tlačítko parsovaných řádků
                parseModalButton.addEventListener('click', function() {
                    showParsedLinesModal();
                });
            }

            // Odstranění logiky pro přidávání nových tlačítek, protože už existují v HTML
            const middleContent = document.querySelector('.middle-content');
            const simulatorButton = document.getElementById('simulatorButton');

            // Když byl simulatorButton předtím nahrazen, obnoví se jeho funkcionalita
            if (simulatorButton) {
                simulatorButton.onclick = function () {
                    toggleTopPanel();
                };
            }

            // ...existing code...

            // Odstraním část kódu, která přidávala duplicitní tlačítka
            // V původní verzi byl zde kód, který přidával duplicitní parametersButton a parseModalButton
            // Místo toho se zajistí, že event listenery jsou připojeny ke stávajícím tlačítkům

            // ...existing code...
        });

        // Na konci souboru najdu a upravím section, která vytváří duplicitní tlačítka
        document.addEventListener('DOMContentLoaded', () => {
            // ...existing code...

            // UPRAVÍM TUTO SEKCI - Odstraním vytváření nových tlačítek a místo toho
            // jen přidám event listenery k již existujícím tlačítkům
            const middleContent = document.querySelector('.middle-content');
            const parametersButton = document.getElementById('parametersButton');
            const parseModalButton = document.getElementById('parseModalButton');

            if (parametersButton) {
                parametersButton.addEventListener('click', showParametersModal);
            }

            if (parseModalButton) {
                parseModalButton.addEventListener('click', showParsedLinesModal);
            }

            // ...existing code...
        });

        // Ujistím se, že funkce pro modální okna jsou definovány správně
        // Modální okno pro parametry
        function showParametersModal() {
            // Odstranit existující modální okno, pokud existuje
            const existingModal = document.getElementById('parametersModal');
            if (existingModal) existingModal.remove();

            // Vytvořit nové modální okno
            const modal = document.createElement('div');
            modal.id = 'parametersModal';
            modal.className = 'modal-window';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>Parametry CNC programu</h3>
                        <button class="modal-close">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div id="parametersContent">
                            <p>Načtěte CNC program pro zobrazení parametrů.</p>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            // Přidat event listener pro zavření modálního okna
            modal.querySelector('.modal-close').addEventListener('click', function() {
                modal.remove();
            });

            // Pokud máme aktivní program, analyzujeme jeho parametry
            if (activeProgram) {
                const code = activeProgram.dataset.code;
                analyzeProgramParameters(code);
            }

            // Přidat zavírání kliknutím mimo modální okno
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });

            // Zobrazit modální okno s animací
            setTimeout(() => modal.classList.add('open'), 10);
        }

        // Modální okno pro parsované řádky
        function showParsedLinesModal() {
            // Odstranit existující modální okno, pokud existuje
            const existingModal = document.getElementById('parsedLinesModal');
            if (existingModal) existingModal.remove();

            // Vytvořit nové modální okno
            const modal = document.createElement('div');
            modal.id = 'parsedLinesModal';
            modal.className = 'modal-window';
            modal.innerHTML = `
                <div class="modal-content wide">
                    <div class="modal-header">
                        <h3>Parsované řádky CNC programu</h3>
                        <button class="modal-close">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div id="parsedLinesContent">
                            <p>Načtěte CNC program pro zobrazení parsovaných řádků.</p>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            // Přidat event listener pro zavření modálního okna
            modal.querySelector('.modal-close').addEventListener('click', function() {
                modal.remove();
            });

            // Pokud máme aktivní program, parsujeme jeho řádky
            if (activeProgram) {
                const code = activeProgram.dataset.code;
                showParsedLines(code);
            }

            // Přidat zavírání kliknutím mimo modální okno
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });

            // Zobrazit modální okno s animací
            setTimeout(() => modal.classList.add('open'), 10);
        }
    </script>
    <script>
        // Implementace vylepšeného číslování řádků
        function setupImprovedLineNumbers() {
            const textarea = document.querySelector('#bottomEditor textarea');
            if (!textarea) {
                console.warn('Textarea element nenalezen');
                return;
            }

            console.log('Inicializace vylepšeného číslování řádků');

            // Odstranit existující číslování řádků pokud existuje
            const container = textarea.parentElement;
            const existingLineNumbers = container.querySelector('.line-numbers');
            if (existingLineNumbers) {
                existingLineNumbers.remove();
            }

            // Přidat CSS styly pro číslování řádků
            const styleId = 'improved-line-numbers-style';
            let style = document.getElementById(styleId);
            if (!style) {
                style = document.createElement('style');
                style.id = styleId;
                style.textContent = `
                    .editor {
                        position: relative;
                    }
                    .line-numbers {
                        position: absolute;
                        top: 1.5rem;
                        left: 0;
                        width: 40px;
                        height: calc(100% - 1.5rem);
                        background-color: #f5f5f5;
                        border-right: 1px solid #ddd;
                        padding-top: 0;
                        font-family: monospace;
                        font-size: 1rem;
                        color: #777;
                        user-select: none;
                        pointer-events: none;
                        z-index: 2;
                        overflow: hidden;
                    }
                    .editor textarea {
                        padding-left: 45px !important;
                        line-height: 1.5rem !important;
                        font-family: monospace !important;
                        font-size: 1rem !important;
                        white-space: pre !important;
                        tab-size: 4;
                    }
                    .line-number {
                        display: block;
                        height: 1.5rem;
                        line-height: 1.5rem;
                        text-align: right;
                        padding-right: 5px;
                    }
                `;
                document.head.appendChild(style);
            }

            // Vytvořit kontejner pro čísla řádků
            const lineNumbers = document.createElement('div');
            lineNumbers.className = 'line-numbers';
            container.appendChild(lineNumbers);

            // Funkce pro aktualizaci čísel řádků
            function updateLineNumbers() {
                const text = textarea.value;
                const lines = text.split('\n');

                // Vyčistit kontejner
                lineNumbers.innerHTML = '';

                // Vytvořit elementy pro každou řádku
                for (let i = 0; i < lines.length; i++) {
                    const line = document.createElement('div');
                    line.className = 'line-number';
                    line.textContent = (i + 1);
                    lineNumbers.appendChild(line);
                }

                // Synchronizovat scroll
                lineNumbers.scrollTop = textarea.scrollTop;
            }

            // Přidat event listenery
            textarea.addEventListener('input', updateLineNumbers);
            textarea.addEventListener('scroll', () => {
                lineNumbers.scrollTop = textarea.scrollTop;
            });
            textarea.addEventListener('keydown', () => {
                // Odložit aktualizaci po keydown
                setTimeout(updateLineNumbers, 10);
            });

            // Inicializovat číslování
            updateLineNumbers();

            // Pro jistotu naplánovat několik aktualizací
            setTimeout(updateLineNumbers, 100);
            setTimeout(updateLineNumbers, 500);

            // Exportovat funkci pro použití jinde
            return updateLineNumbers;
        }

        // Oprava funkce pro přepínání horního panelu
        function toggleTopPanel() {
            const topPanel = document.getElementById('topPanel');

            if (!topPanel) {
                console.error('Top panel element not found');
                return;
            }

            // Přepnout třídu 'hidden' místo 'open'
            topPanel.classList.toggle('hidden');

            const isHidden = topPanel.classList.contains('hidden');
            const container = document.querySelector('.container');
            const simulatorButton = document.getElementById('simulatorButton');
            const toggleBtn = document.getElementById('toggleTopPanelBtn');

            if (isHidden) {
                // Panel byl právě skryt
                console.log('Skrývání horního panelu');

                // Uložit aktuální výšky pro pozdější obnovení
                window.originalTopHeight = topHeight;
                window.originalBottomHeight = bottomHeight;

                // Resetovat margin kontejneru
                if (container) container.style.marginTop = '0';

                // Aktualizovat tlačítko
                if (toggleBtn) toggleBtn.textContent = '↓';

                // Aktualizovat stav tlačítka simulátoru
                if (simulatorButton) {
                    simulatorButton.classList.remove('active');
                    simulatorButton.title = "Zobrazit seznam programů";
                }
            } else {
                // Panel byl právě zobrazen
                console.log('Zobrazování horního panelu');

                // Obnovit původní výšky, pokud existují
                if (typeof window.originalTopHeight !== 'undefined' &&
                    typeof window.originalBottomHeight !== 'undefined') {
                    topHeight = window.originalTopHeight;
                    bottomHeight = window.originalBottomHeight;
                }

                // Přizpůsobit výšku panelu podle počtu programů
                const programList = document.getElementById('programList');
                const items = programList ? programList.children : [];
                const controlsHeight = 45;
                const itemWidth = 150;
                const availableWidth = window.innerWidth - 150;
                const itemsPerRow = Math.floor(availableWidth / itemWidth);
                const rows = Math.ceil(items.length / itemsPerRow) || 1;
                const panelHeight = rows === 1 ? controlsHeight : controlsHeight * rows;

                // Nastavit výšku panelu a margin kontejneru
                topPanel.style.height = `${panelHeight}px`;
                if (container) container.style.marginTop = `${panelHeight}px`;

                // Upravit výšky editorů
                const reduction = (panelHeight / window.innerHeight) * 100;
                const ratio = topHeight / (topHeight + bottomHeight);
                const availableSpace = 100 - reduction;

                topHeight = availableSpace * ratio;
                bottomHeight = availableSpace * (1 - ratio);

                // Aktualizovat tlačítko
                if (toggleBtn) toggleBtn.textContent = '×';

                // Aktualizovat stav tlačítka simulátoru
                if (simulatorButton) {
                    simulatorButton.classList.add('active');
                    simulatorButton.title = "Skrýt seznam programů";
                }
            }

            // Aktualizovat výšky všech elementů
            updateHeights();
            console.log(`Panel je nyní ${isHidden ? 'skrytý' : 'viditelný'}`);
        }

        // Inicializace po načtení DOMu - přidat mezi existující event listenery
        document.addEventListener('DOMContentLoaded', function() {
            // ...existing code...

            // Inicializovat vylepšené číslování řádků
            setupImprovedLineNumbers();

            // Nahradit všechny existující implementace funkcí pro číslování řádků
            window.setupSimpleLineNumbers = setupImprovedLineNumbers;
            window.refreshLineNumbers = setupImprovedLineNumbers;

            // Přidat event listener pro simulatorButton pro přepínání panelu
            const simulatorButton = document.getElementById('simulatorButton');
            if (simulatorButton) {
                simulatorButton.onclick = toggleTopPanel;
            }

            // Přidat event listener pro tlačítko zavření v horním panelu
            const toggleTopPanelBtn = document.getElementById('toggleTopPanelBtn');
            if (toggleTopPanelBtn) {
                toggleTopPanelBtn.onclick = toggleTopPanel;
            }

            // ...existing code...
        });
    </script>
</body>

</html>